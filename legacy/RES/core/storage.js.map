{"version":3,"sources":["core/storage.js"],"names":[],"mappings":"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","file":"core/storage.js","sourcesContent":["/* exported RESStorage */\r\n\r\nvar RESStorage = RESStorage || {};\r\n\r\nRESStorage.setup = function() {\r\n\tif (!RESStorage.setup._complete) {\r\n\t\tRESStorage.setup._complete = $.Deferred();\r\n\t\tRESEnvironment.storageSetup({ requestType: 'getLocalStorage' });\r\n\t}\r\n\treturn RESStorage.setup._complete;\r\n};\r\n\r\nRESStorage.setup.complete = function(underlyingStorage) {\r\n\tfor (var key in underlyingStorage) {\r\n\t\tif (typeof underlyingStorage[key] === 'function') {\r\n\t\t\tRESStorage[key] = underlyingStorage[key].bind(underlyingStorage);\r\n\t\t} else {\r\n\t\t\tRESStorage[key] = underlyingStorage[key];\r\n\t\t}\r\n\t}\r\n\r\n\tRESStorage.isReady = true;\r\n\r\n\tvar error = RESStorage.setup.testLocalStorage();\r\n\tif (!error) {\r\n\t\tRESStorage.setup._complete.resolve();\r\n\t} else {\r\n\t\tRESStorage.setup._complete.reject(error);\r\n\t}\r\n};\r\n\r\nRESStorage.setup.testLocalStorage = function() {\r\n\tvar error;\r\n\r\n\t// Check for localStorage functionality...\r\n\ttry {\r\n\t\tvar localStorage = RESEnvironment.localStorage();\r\n\t\tif (localStorage) {\r\n\t\t\tlocalStorage.setItem('RES.localStorageTest', 'test');\r\n\t\t}\r\n\t} catch (e) {\r\n\t\terror = e;\r\n\t}\r\n\r\n\treturn error;\r\n};\r\n\r\nRESStorage.loadItem = function(key) {\r\n\tif (arguments.length > 1) {\r\n\t\treturn RESUtils.deferred.all(Array.prototype.slice.call(arguments).map(function(key) {\r\n\t\t\treturn RESStorage.loadItem(key);\r\n\t\t}));\r\n\t}\r\n\treturn RESStorage.setup._complete\r\n\t\t.then(function() {\r\n\t\t\treturn RESStorage.getItem(key);\r\n\t\t});\r\n};\r\n\r\nRESStorage.getItem = function(key) {\r\n\t// Make sure to call RESStorage.loadItem(key) or RESStorage.loadItem(...keys)\r\n\t// and ensure it is done or return it from a module's beginning-of-lifecycle\r\n\t// callbacks: loadDynamicOptions, beforeLoad, go\r\n\t// before calling RESStorage.getItem(key) directly.\r\n\tif (!RESStorage.setup._complete || RESStorage.setup._complete.state() !== 'resolved') {\r\n\t\ttry {\r\n\t\t\tthrow 'RESStorage.getItem(\"' + key + '\") called before RESStorage.loadItem(\"' + key + '\").';\r\n\t\t} catch (e) {\r\n\t\t\tconsole.error(e, e.stack);\r\n\t\t}\r\n\t}\r\n\r\n\tif (typeof RESStorage[key] !== 'undefined') {\r\n\t\treturn RESStorage[key];\r\n\t}\r\n\treturn null;\r\n};\r\n\r\n// If the fromBG parameter is true, we've been informed by another tab\r\n// that this item has updated. We should update the data locally, but\r\n// not send a background request.\r\nRESStorage.setItem = function(key, value, fromBG) {\r\n\t// Protect from excessive disk I/O...\r\n\tif (RESStorage[key] !== value) {\r\n\t\t// Save it locally in the RESStorage variable, but also write it\r\n\t\t// to the extension's localStorage...\r\n\t\t// It's OK that saving it is asynchronous since we're saving it\r\n\t\t// in this local variable, too...\r\n\t\tRESStorage[key] = value;\r\n\r\n\t\tif (!fromBG) {\r\n\t\t\tvar thisJSON = {\r\n\t\t\t\trequestType: 'localStorage',\r\n\t\t\t\toperation: 'setItem',\r\n\t\t\t\titemName: key,\r\n\t\t\t\titemValue: value\r\n\t\t\t};\r\n\r\n\t\t\tRESEnvironment.sendMessage(thisJSON);\r\n\t\t}\r\n\t}\r\n};\r\n\r\nRESStorage.removeItem = function(key) {\r\n\t// Delete it locally in the RESStorage variable, but also delete it\r\n\t// from the extension's localStorage...\r\n\t// It's OK that deleting it is asynchronous since we're deleting it in\r\n\t// this local variable, too...\r\n\tdelete RESStorage[key];\r\n\tvar thisJSON = {\r\n\t\trequestType: 'localStorage',\r\n\t\toperation: 'removeItem',\r\n\t\titemName: key\r\n\t};\r\n\r\n\tRESEnvironment.sendMessage(thisJSON);\r\n};\r\n\r\nif (typeof exports === 'object') {\r\n\texports.RESStorage = RESStorage;\r\n}\r\n"],"sourceRoot":"/source/"}