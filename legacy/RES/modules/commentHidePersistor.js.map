{"version":3,"sources":["modules/commentHidePersistor.js"],"names":[],"mappings":"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","file":"modules/commentHidePersistor.js","sourcesContent":["/**\r\n * CommentHidePersistor - stores hidden comments in localStorage and re-hides\r\n * them on reload of the page.\r\n **/\r\naddModule('commentHidePersistor', function(module, moduleID) {\r\n\tmodule.moduleName = 'Comment Hide Persistor';\r\n\tmodule.category = 'Comments';\r\n\tmodule.description = 'Saves the state of hidden comments across page views.';\r\n\r\n\tmodule.include = [\r\n\t\t'comments'\r\n\t];\r\n\r\n\tmodule.beforeLoad = function() {\r\n\t\treturn RESStorage.loadItem('RESmodules.commentHidePersistor.hidePersistor');\r\n\t};\r\n\r\n\tmodule.go = function() {\r\n\t\tif ((this.isEnabled()) && (this.isMatchURL())) {\r\n\t\t\tbindToHideLinks();\r\n\t\t\thideHiddenThings();\r\n\t\t}\r\n\t};\r\n\r\n\tvar allHiddenThings = {};\r\n\tvar hiddenKeys = [];\r\n\tvar hiddenThings = [];\r\n\tvar hiddenThingsKey = window.location.href;\r\n\tvar maxKeys = 100;\r\n\tvar pruneKeysTo = 50;\r\n\r\n\tfunction bindToHideLinks() {\r\n\t\t/**\r\n\t\t * For every expand/collapse link, add a click listener that will\r\n\t\t * store or remove the comment ID from our list of hidden comments.\r\n\t\t **/\r\n\t\t$('body').on('click', 'a.expand', function() {\r\n\t\t\tvar $thing = $(this).parents('.thing:eq(0)'),\r\n\t\t\t\tthingId = $thing.data('fullname'),\r\n\t\t\t\tcollapsing = $thing.is('.collapsed') || $(this).parent().parent().hasClass('noncollapsed');\r\n\r\n\t\t\t/* Add our key to pages interacted with, for potential pruning later */\r\n\t\t\tif (hiddenKeys.indexOf(hiddenThingsKey) === -1) {\r\n\t\t\t\thiddenKeys.push(hiddenThingsKey);\r\n\t\t\t}\r\n\r\n\t\t\tif (collapsing) {\r\n\t\t\t\taddHiddenThing(thingId);\r\n\t\t\t} else {\r\n\t\t\t\tremoveHiddenThing(thingId);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction loadHiddenThings() {\r\n\t\tvar hidePersistorJson = RESStorage.getItem('RESmodules.commentHidePersistor.hidePersistor');\r\n\r\n\t\tif (hidePersistorJson) {\r\n\t\t\ttry {\r\n\t\t\t\tvar hidePersistorData = safeJSON.parse(hidePersistorJson);\r\n\t\t\t\tallHiddenThings = hidePersistorData['hiddenThings'];\r\n\t\t\t\thiddenKeys = hidePersistorData['hiddenKeys'];\r\n\r\n\t\t\t\t/**\r\n\t\t\t\t * Prune allHiddenThings of old content so it doesn't get\r\n\t\t\t\t * huge.\r\n\t\t\t\t **/\r\n\t\t\t\tif (hiddenKeys.length > maxKeys) {\r\n\t\t\t\t\tvar pruneStart = maxKeys - pruneKeysTo,\r\n\t\t\t\t\t\tnewHiddenThings = {},\r\n\t\t\t\t\t\tnewHiddenKeys = [];\r\n\r\n\t\t\t\t\t/* Recreate our object as a subset of the original */\r\n\t\t\t\t\tfor (var i = pruneStart; i < hiddenKeys.length; i++) {\r\n\t\t\t\t\t\tvar hiddenKey = hiddenKeys[i];\r\n\t\t\t\t\t\tnewHiddenKeys.push(hiddenKey);\r\n\t\t\t\t\t\tnewHiddenThings[hiddenKey] = allHiddenThings[hiddenKey];\r\n\t\t\t\t\t}\r\n\t\t\t\t\tallHiddenThings = newHiddenThings;\r\n\t\t\t\t\thiddenKeys = newHiddenKeys;\r\n\t\t\t\t\tsyncHiddenThings();\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (typeof allHiddenThings[hiddenThingsKey] !== 'undefined') {\r\n\t\t\t\t\thiddenThings = allHiddenThings[hiddenThingsKey];\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t} catch (e) {\r\n\t\t\t\t// ignore\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction addHiddenThing(thingId) {\r\n\t\tvar i = hiddenThings.indexOf(thingId);\r\n\t\tif (i === -1) {\r\n\t\t\thiddenThings.push(thingId);\r\n\t\t}\r\n\t\tsyncHiddenThings();\r\n\t}\r\n\r\n\tfunction removeHiddenThing(thingId) {\r\n\t\tvar i = hiddenThings.indexOf(thingId);\r\n\t\tif (i !== -1) {\r\n\t\t\thiddenThings.splice(i, 1);\r\n\t\t}\r\n\t\tsyncHiddenThings();\r\n\t}\r\n\r\n\tfunction syncHiddenThings() {\r\n\t\tvar hidePersistorData;\r\n\t\tallHiddenThings[hiddenThingsKey] = hiddenThings;\r\n\t\thidePersistorData = {\r\n\t\t\t'hiddenThings': allHiddenThings,\r\n\t\t\t'hiddenKeys': hiddenKeys\r\n\t\t};\r\n\t\tRESStorage.setItem('RESmodules.commentHidePersistor.hidePersistor', JSON.stringify(hidePersistorData));\r\n\t}\r\n\r\n\tfunction hideHiddenThings() {\r\n\t\tloadHiddenThings();\r\n\r\n\t\tfor (var i = 0, il = hiddenThings.length; i < il; i++) {\r\n\t\t\tvar thingId = hiddenThings[i],\r\n\t\t\t\t$thing = $('div.id-' + thingId),\r\n\t\t\t\t$entry = $thing.children('div.entry');\r\n\r\n\r\n\t\t\tif ($thing.is('.collapsed')) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tvar $hideLink = $entry.find(':not(.collapsed) a.expand');\r\n\r\n\t\t\tif ($hideLink) {\r\n\t\t\t\t/**\r\n\t\t\t\t * Zero-length timeout to defer this action until after the\r\n\t\t\t\t * other modules have finished. For some reason without\r\n\t\t\t\t * deferring the hide was conflicting with the\r\n\t\t\t\t * commentNavToggle width.\r\n\t\t\t\t **/\r\n\t\t\t\t(function($hideLink) {\r\n\t\t\t\t\twindow.setTimeout(function() {\r\n\t\t\t\t\t\t// $hideLink.click();\r\n\t\t\t\t\t\tRESUtils.click($hideLink.get(0));\r\n\t\t\t\t\t}, 0);\r\n\t\t\t\t})($hideLink);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n});\r\n"],"sourceRoot":"/source/"}