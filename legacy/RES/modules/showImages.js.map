{"version":3,"sources":["modules/showImages.js"],"names":[],"mappings":"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","file":"modules/showImages.js","sourcesContent":["/*\r\n\tIf you would like RES to embed content from your website,\r\n\tconsult lib/modules/hosts/example.js\r\n*/\r\naddModule('showImages', function(module, moduleID) {\r\n\tmodule.moduleName = 'Inline Image Viewer';\r\n\tmodule.category = ['Productivity', 'Browsing'];\r\n\tmodule.description = 'Opens images inline in your browser with the click of a button. Also has configuration options, check it out!';\r\n\tmodule.options = {\r\n\t\tconserveMemory: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Conserve memory by temporarily hiding images when they are offscreen.'\r\n\t\t},\r\n\t\tpreloadImages: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'Preload gallery images for faster browsing. Beware: this is at the expense of lots of bandwidth usage.'\r\n\t\t},\r\n\t\tbufferScreens: {\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: 2,\r\n\t\t\tdescription: 'Hide images that are further than x screens away to save memory. A higher value means less flicker, but less memory savings.',\r\n\t\t\tdependsOn: 'conserveMemory',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tmaxWidth: {\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: '640',\r\n\t\t\tdescription: 'Max width of image displayed onscreen',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tmaxHeight: {\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: '480',\r\n\t\t\tdescription: 'Max height of image displayed onscreen',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tdisplayOriginalResolution: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'Display each image\\'s original (unresized) resolution in a tooltip.'\r\n\t\t},\r\n\t\tselfTextMaxHeight: {\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: 0,\r\n\t\t\tdescription: 'Add a scroll bar to text expandos taller than [x] pixels (enter zero for unlimited).',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tcommentMaxHeight: {\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: 0,\r\n\t\t\tdescription: 'Add a scroll bar to comments taller than [x] pixels (enter zero for unlimited).',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tautoMaxHeight: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'Increase the max height of a self-text expando or comment if an expando is taller than the current max height.\\\r\n\t\t\t\tThis only takes effect if max height is specified (previous two options).',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\topenInNewWindow: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Open images in a new tab/window when clicked?'\r\n\t\t},\r\n\t\thideNSFW: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'If checked, do not show images marked NSFW.'\r\n\t\t},\r\n\t\thighlightNSFWButton: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Add special styling to expando buttons for images marked NSFW.',\r\n\t\t\tbodyClass: true\r\n\t\t},\r\n\t\tautoExpandSelfText: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'When loading selftext from an Aa+ expando, auto expand images, videos, and embeds.'\r\n\t\t},\r\n\t\timageZoom: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Allow dragging to resize/zoom images.'\r\n\t\t},\r\n\t\timageMove: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Allow dragging while holding shift to move images.'\r\n\t\t},\r\n\t\tclippy: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Show educational tooltips, such as showing \"drag to resize\" when your mouse hovers over an image.'\r\n\t\t},\r\n\t\tmarkVisited: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Mark links visited when you view images (does eat some resources).',\r\n\t\t\tadvanced: true\r\n\t\t},\r\n\t\tsfwHistory: {\r\n\t\t\ttype: 'enum',\r\n\t\t\tvalue: 'add',\r\n\t\t\tvalues: [{\r\n\t\t\t\tname: 'Add links to history',\r\n\t\t\t\tvalue: 'add'\r\n\t\t\t}, {\r\n\t\t\t\tname: 'Color links, but do not add to history',\r\n\t\t\t\tvalue: 'color'\r\n\t\t\t}, {\r\n\t\t\t\tname: 'Do not add or color links.',\r\n\t\t\t\tvalue: 'none'\r\n\t\t\t}],\r\n\t\t\tdescription: 'Keeps NSFW links from being added to your browser history <span style=\"font-style: italic\">by the markVisited feature</span>.<br/>\\\r\n\t\t\t\t<span style=\"font-style: italic\">If you chose the second option, then links will be blue again on refresh.</span><br/>\\\r\n\t\t\t\t<span style=\"color: red\">This does not change your basic browser behavior.\\\r\n\t\t\t\tIf you click on a link then it will still be added to your history normally.\\\r\n\t\t\t\tThis is not a substitute for using your browser\\'s privacy mode.</span>'\r\n\t\t},\r\n\t\tignoreDuplicates: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Do not create expandos for images that appear multiple times in a page.'\r\n\t\t},\r\n\t\tdisplayImageCaptions: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Retrieve image captions/attribution information.',\r\n\t\t\tadvanced: true,\r\n\t\t\tbodyClass: true\r\n\t\t},\r\n\t\tloadAllInAlbum: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'Display all images at once in a \\'filmstrip\\' layout, rather than the default navigable \\'slideshow\\' style.'\r\n\t\t},\r\n\t\tdontLoadAlbumsBiggerThan: {\r\n\t\t\tdependsOn: 'loadAllInAlbum',\r\n\t\t\ttype: 'text',\r\n\t\t\tvalue: 30,\r\n\t\t\tdescription: 'Use the \\'slideshow\\' style for albums with more images than this number. (0 for always use \\'filmstrip\\')'\r\n\t\t},\r\n\t\tconvertGifstoGfycat: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: false,\r\n\t\t\tdescription: 'Convert Gif links to Gfycat links.'\r\n\t\t},\r\n\t\tshowViewImagesTab: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Show a \\'view images\\' tab at the top of each subreddit, to easily toggle showing all images at once.'\r\n\t\t},\r\n\t\tautoplayVideo: {\r\n\t\t\ttype: 'boolean',\r\n\t\t\tvalue: true,\r\n\t\t\tdescription: 'Autoplay inline videos'\r\n\t\t}\r\n\t};\r\n\tmodule.exclude = [\r\n\t\t/^https?:\\/\\/(?:[\\-\\w\\.]+\\.)?reddit\\.com\\/ads\\/[\\-\\w\\.\\_\\?=]*/i,\r\n\t\t/^https?:\\/\\/(?:[\\-\\w\\.]+\\.)?reddit\\.com\\/[\\-\\w\\.\\/]*\\/submit\\/?$/i\r\n\t];\r\n\tmodule.loadLibraries = function() {\r\n\t\treturn RESUtils.init.await.library('mediaHosts').then(function(siteModules) {\r\n\t\t\t$.extend(module.siteModules, siteModules);\r\n\t\t});\r\n\t};\r\n\tmodule.loadDynamicOptions = function() {\r\n\t\t// Augment the options with available image modules\r\n\t\tfor (var site in this.siteModules) {\r\n\t\t\t// Ignore default\r\n\t\t\tif (site === 'default') continue;\r\n\t\t\tif (site === 'defaultVideo') continue;\r\n\t\t\tif (site === 'defaultAudio') continue;\r\n\r\n\t\t\t// Auto add on / off options\r\n\t\t\tcreateSiteModuleEnabledOption(site);\r\n\r\n\t\t\t// Find out if module has any additional options - if it does add them\r\n\t\t\tif (this.siteModules[site].options !== 'undefined'){\r\n\t\t\t\tfor (var optionKey in this.siteModules[site].options) {\r\n\t\t\t\t\tthis.options[optionKey] = this.siteModules[site].options[optionKey];\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tfunction createSiteModuleEnabledOption(site){\r\n\t\t// Create on/off option for given module\r\n\t\tvar name = (typeof module.siteModules[site].name !== 'undefined') ? module.siteModules[site].name : site;\r\n\t\tmodule.options['display ' + name] = {\r\n\t\t\tdescription: 'Display expander for ' + name,\r\n\t\t\tvalue: true,\r\n\t\t\ttype: 'boolean'\r\n\t\t};\r\n\t}\r\n\r\n\tvar imageList = [];\r\n\tvar imagesRevealed = {};\r\n\tvar dupeAnchors = 0;\r\n\t/*\r\n\t true: show all images\r\n\t false: hide all images\r\n\t 'any string': display images match the tab\r\n\t */\r\n\tvar currentImageTab = false;\r\n\tvar customImageTabs = {};\r\n\tvar imageTrackStack = [];\r\n\tvar scanningForImages = false;\r\n\tvar scanningSelfText = false;\r\n\r\n\tmodule.beforeLoad = function() {\r\n\t\tif ((this.isEnabled()) && (this.isMatchURL())) {\r\n\t\t\tvar selfTextMaxHeight = parseInt(this.options.selfTextMaxHeight.value, 10);\r\n\t\t\tif (selfTextMaxHeight) {\r\n\t\t\t\t// Strange selector necessary to select tumblr expandos, etc.\r\n\t\t\t\tRESUtils.addCSS('.selftext.expanded ~ * .md { max-height: ' + selfTextMaxHeight + 'px; overflow-y: auto !important; position: relative; }');\r\n\t\t\t}\r\n\t\t\tvar commentMaxHeight = parseInt(this.options.commentMaxHeight.value, 10);\r\n\t\t\tif (commentMaxHeight) {\r\n\t\t\t\tRESUtils.addCSS('.comment .md { max-height: ' + commentMaxHeight + 'px; overflow-y: auto !important; position: relative; }');\r\n\t\t\t}\r\n\r\n\t\t\t// Generate domain to module map\r\n\t\t\tgenerateDomainModuleMap();\r\n\t\t}\r\n\t};\r\n\r\n\tmodule.go = function() {\r\n\t\tif ((this.isEnabled()) && (this.isMatchURL())) {\r\n\r\n\t\t\tif (this.options.conserveMemory.value) {\r\n\t\t\t\twindow.addEventListener('scroll', RESUtils.debounce.bind(RESUtils, 'scroll.showImages', 300, handleScroll), false);\r\n\t\t\t}\r\n\r\n\t\t\tRESUtils.watchForElement('siteTable', findAllImages);\r\n\t\t\tRESUtils.watchForElement('selfText', findAllImagesInSelfText);\r\n\t\t\tRESUtils.watchForElement('newComments', findAllImagesInSelfText);\r\n\r\n\t\t\tcreateImageButtons();\r\n\t\t\tfindAllImages();\r\n\t\t\tdocument.addEventListener('dragstart', function() {\r\n\t\t\t\treturn false;\r\n\t\t\t}, false);\r\n\t\t}\r\n\t};\r\n\r\n\tfunction handleScroll() {\r\n\t\timageList.some(function(image) {\r\n\t\t\tvar thisXY = RESUtils.getXYpos(image);\r\n\t\t\tif (image && thisXY.y > window.pageYOffset) {\r\n\t\t\t\tlazyUnload();\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction lazyUnload() {\r\n\t\t// hide any expanded images that are further than bufferScreens above or below viewport\r\n\t\t// show any expanded images that are within bufferScreens of viewport\r\n\t\tvar bufferScreens = module.options.bufferScreens.value || 2,\r\n\t\t\tviewportHeight = $(window).height(),\r\n\t\t\tmaximumTop = viewportHeight * (bufferScreens + 1),\r\n\t\t\tminimumBottom = viewportHeight * bufferScreens * -1,\r\n\t\t\tboundingBox;\r\n\r\n\t\timageList.forEach(function(image) {\r\n\t\t\tif (image.imageLink && image.imageLink.image) {\r\n\t\t\t\tboundingBox = image.imageLink.image.getBoundingClientRect();\r\n\t\t\t\tif (boundingBox.top > maximumTop || boundingBox.bottom < minimumBottom) {\r\n\t\t\t\t\tunloadRevealedImage(image);\r\n\t\t\t\t} else {\r\n\t\t\t\t\treloadRevealedImage(image);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tvar transparentGif = 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==';\r\n\r\n\tfunction unloadRevealedImage(ele) {\r\n\t\tvar src, width, height,\r\n\t\t\t$img;\r\n\r\n\t\tif (ele.imageLink && ele.imageLink.image) {\r\n\t\t\t$img = $(ele.imageLink.image);\r\n\t\t\tsrc = $img.attr('src');\r\n\t\t\tif (src === transparentGif) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\twidth = $img.width();\r\n\t\t\theight = $img.height();\r\n\t\t\t// only hide the image if it has a width and height (it may not be loaded yet)\r\n\t\t\tif (width && height && $img.data('loaded')) {\r\n\t\t\t\t// preserve src and set the width to height to make the page not jump\r\n\t\t\t\t$img.data('src', src).attr('width', width).attr('height', height);\r\n\t\t\t\t// swap img with transparent gif to save memory\r\n\t\t\t\t$img.attr('src', transparentGif);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction reloadRevealedImage(ele) {\r\n\t\tvar src, $img;\r\n\r\n\t\tif (ele.imageLink && ele.imageLink.image) {\r\n\t\t\t$img = $(ele.imageLink.image);\r\n\t\t\tsrc = $img.data('src');\r\n\t\t\tif (src && ($img.attr('src') === transparentGif)) {\r\n\t\t\t\t$img.attr('src', src);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction findAllImagesInSelfText(ele) {\r\n\t\tfindAllImages(ele, true);\r\n\t}\r\n\r\n\tvar viewImageButton;\r\n\r\n\tfunction createImageButtons() {\r\n\t\tvar mainMenuUL = $('#header-bottom-left ul.tabmenu')[0];\r\n\t\t// Create new tabmenu on these pages, regardless if one already exists.\r\n\t\tif ((RESUtils.regexes.search.test(location.href)) ||\r\n\t\t\t\t(/\\/about\\/(?:reports|spam|unmoderated)/.test(location.href)) ||\r\n\t\t\t\t(location.href.indexOf('/modqueue') !== -1) ||\r\n\t\t\t\t(location.href.toLowerCase().indexOf('/dashboard') !== -1)) {\r\n\t\t\tmainMenuUL = RESUtils.createElement('ul', null, 'tabmenu viewimages');\r\n\t\t\tdocument.getElementById('header-bottom-left').appendChild(mainMenuUL);\r\n\t\t\tmainMenuUL.style.display = 'inline-block'; // Override dashboard's subreddit style.\r\n\t\t}\r\n\r\n\t\tif (mainMenuUL) {\r\n\t\t\tvar viewImagesLI = document.createElement('li');\r\n\t\t\tvar viewImagesLink = document.createElement('a');\r\n\t\t\tvar viewImagesText = document.createTextNode('scanning for images...');\r\n\t\t\tscanningForImages = true;\r\n\r\n\t\t\tviewImagesLink.href = '#';\r\n\t\t\tviewImagesLink.id = 'viewImagesButton';\r\n\t\t\tviewImagesLink.addEventListener('click', function(e) {\r\n\t\t\t\te.preventDefault();\r\n\t\t\t\tif (!scanningForImages) {\r\n\t\t\t\t\tmodule.setShowImages(null, 'image');\r\n\t\t\t\t}\r\n\t\t\t}, true);\r\n\t\t\tviewImagesLink.appendChild(viewImagesText);\r\n\t\t\tviewImagesLI.appendChild(viewImagesLink);\r\n\t\t\tif (module.options.showViewImagesTab.value) {\r\n\t\t\t\tmainMenuUL.appendChild(viewImagesLI);\r\n\t\t\t}\r\n\t\t\tviewImageButton = viewImagesLink;\r\n\r\n\t\t\t/*\r\n\t\t\t\tTo enable custom image tabs for a subreddit start by adding `[](#/RES_SR_Config/ImageTabs?)` to the markdown code of the sidebar.\r\n\t\t\t\tThis should not have any visible effect on the HTML.\r\n\t\t\t\tRight now no options have been configured, so there won't be any new tabs.\r\n\t\t\t\tYou can add up to 8 tabs in the following manner:\r\n\t\t\t\tA tab is defined by a label and a tag list separated by an equals sign like this: `LABEL=TAGLIST`\r\n\t\t\t\tThe label can be up to 32 characters long and may contain english letters, numbers, hyphens, spaces, and underscores. The labels must be URI encoded.\r\n\t\t\t\tThe tag list can contain up to tag values separated by commas. Individual tags have the same content restrictions a labels. (do not URI encode the commmas)\r\n\r\n\t\t\t\tThe the tab definitions are joined by ampersands (`&`).\r\n\t\t\t\tLabels appear to the right of the \"view images\" button and are surrounded by `[]` brackets.\r\n\t\t\t\tPost titles are searched for any place that an entry in the tag list appears surrounded by any kind of bracket <>, [], (), {}.\r\n\t\t\t\tTags are not case sensitive and whitespace is permitted between the brackets and the tag.\r\n\r\n\t\t\t\tTo allow the tabs to be styled, the tabs will have a class that is the tab label with the spaces and hyphens replaced by underscores and then prefixed with `'RESTab-'` so the label 'Feature Request' becomes `'RESTab-feature_request'`.\r\n\r\n\t\t\t\tWe realize that the format is highly restrictive, but you must understand that that is for everyone's protection. If there is demand, the filter can be expanded.\r\n\r\n\t\t\t\tExamples:\r\n\t\t\t\tA hypothetical setup for /r/minecraft that creates tabs for builds, mods, and texture packs:\r\n\r\n\t\t\t\t\t[](#/RES_SR_Config/ImageTabs?build=build,project&mod=mod&texture%20pack=texture,textures,pack,texture%20pack)\r\n\r\n\t\t\t\tTo duplicate the behavior originally used for /r/gonewild you would use:\r\n\r\n\t\t\t\t\t[](#/RES_SR_Config/ImageTabs?m=m,man,male&f=f,fem,female)\r\n\r\n\t\t\t */\r\n\t\t\tvar tabConfig = document.querySelector('.side .md a[href^=\"#/RES_SR_Config/ImageTabs\"]');\r\n\r\n\t\t\tif (tabConfig) {\r\n\t\t\t\tvar switches = {},\r\n\t\t\t\t\tswitchCount = 0,\r\n\t\t\t\t\twhitelist = /^[A-Za-z0-9_ \\-]{1,32}$/,\r\n\t\t\t\t\tconfigString = tabConfig.hash.match(/\\?(.*)/);\r\n\r\n\t\t\t\tif (configString !== null) {\r\n\t\t\t\t\tvar pairs = configString[1].split('&');\r\n\t\t\t\t\tfor (var i = 0; i < pairs.length && switchCount < 8; i++) {\r\n\t\t\t\t\t\tvar pair = pairs[i].split('=');\r\n\t\t\t\t\t\tif (pair.length !== 2) continue;\r\n\t\t\t\t\t\tvar label = decodeURIComponent(pair[0]);\r\n\t\t\t\t\t\tif (!whitelist.test(label)) continue;\r\n\t\t\t\t\t\tvar parts = pair[1].split(',');\r\n\t\t\t\t\t\tvar acceptedParts = [];\r\n\t\t\t\t\t\tfor (var j = 0; j < parts.length && acceptedParts.length < 8; j++) {\r\n\t\t\t\t\t\t\tvar part = decodeURIComponent(parts[j]);\r\n\t\t\t\t\t\t\tif (!whitelist.test(part)) continue;\r\n\t\t\t\t\t\t\telse acceptedParts.push(part);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (acceptedParts.length > 0) {\r\n\t\t\t\t\t\t\tif (!(label in switches)) switchCount++;\r\n\t\t\t\t\t\t\tswitches[label] = acceptedParts;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (switchCount > 0) {\r\n\t\t\t\t\tfor (var key in switches) {\r\n\t\t\t\t\t\tcustomImageTabs[key] = new RegExp('[\\\\[\\\\{\\\\<\\\\(]\\\\s*(' + switches[key].join('|') + ')\\\\s*[\\\\]\\\\}\\\\>\\\\)]', 'i');\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!/comments\\/[\\-\\w\\.\\/]/i.test(location.href)) {\r\n\t\t\t\tfor (var mode in customImageTabs) {\r\n\t\t\t\t\tvar li = document.createElement('li'),\r\n\t\t\t\t\t\ta = document.createElement('a'),\r\n\t\t\t\t\t\ttext = document.createTextNode('[' + mode + ']');\r\n\t\t\t\t\ta.href = '#';\r\n\t\t\t\t\ta.className = 'RESTab-' + mode.toLowerCase().replace(/- /g, '_');\r\n\t\t\t\t\ta.addEventListener('click', (function(mode) {\r\n\t\t\t\t\t\treturn function(e) {\r\n\t\t\t\t\t\t\te.preventDefault();\r\n\t\t\t\t\t\t\tmodule.setShowImages(mode);\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t})(mode), true);\r\n\r\n\t\t\t\t\ta.appendChild(text);\r\n\t\t\t\t\tli.appendChild(a);\r\n\t\t\t\t\tmainMenuUL.appendChild(li);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t$.each(module.siteModules, function(key, siteModule) {\r\n\t\t\tif (!siteModule) return;\r\n\t\t\tif (!module.siteModules.hasOwnProperty(key)) return;\r\n\t\t\tif (typeof siteModule.go === 'function') {\r\n\t\t\t\tsiteModule.go();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tmodule.setShowImages = function(newImageTab, type) {\r\n\t\tif (!(module.isEnabled() && module.isMatchURL())) return;\r\n\t\ttype = type || 'image';\r\n\t\tif ([ 'number', 'string' ].indexOf(typeof newImageTab) === -1) {\r\n\t\t\t// This is for the all images button\r\n\t\t\t// If we stored `true` then toggle to false, in all other cases turn it to true\r\n\t\t\tif (currentImageTab === true) {\r\n\t\t\t\tcurrentImageTab = false;\r\n\t\t\t} else {\r\n\t\t\t\tcurrentImageTab = true;\r\n\t\t\t}\r\n\t\t} else if (currentImageTab === newImageTab) {\r\n\t\t\t// If they are the same, turn it off\r\n\t\t\tcurrentImageTab = false;\r\n\t\t} else if (newImageTab in customImageTabs) {\r\n\t\t\t// If the tab is defined, switch to it\r\n\t\t\tcurrentImageTab = newImageTab;\r\n\t\t} else {\r\n\t\t\t// Otherwise ignore it\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tupdateImageButtons();\r\n\t\tupdateRevealedImages(type);\r\n\t};\r\n\r\n\tfunction updateImageButtons() {\r\n\t\tvar imgCount = imageList.length;\r\n\t\tvar showHideText = 'view';\r\n\t\tmodule.haltMediaBrowseMode = false;\r\n\t\tif (currentImageTab === true) {\r\n\t\t\tmodule.haltMediaBrowseMode = true;\r\n\t\t\tshowHideText = 'hide';\r\n\t\t}\r\n\t\tif (viewImageButton) {\r\n\t\t\tvar buttonText = showHideText + ' images ';\r\n\t\t\tif (!RESUtils.currentSubreddit('dashboard')) buttonText += '(' + imgCount + ')';\r\n\t\t\t$(viewImageButton).text(buttonText);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updateRevealedImages(type) {\r\n\t\tfor (var i = 0, len = imageList.length; i < len; i++) {\r\n\t\t\tvar image = imageList[i];\r\n\t\t\tif ($(image).hasClass(type) || image.imageLink.expandOnViewAll) {\r\n\t\t\t\trevealImage(image, findImageFilter(image.imageLink));\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction findImageFilter(image) {\r\n\t\tvar isMatched = false;\r\n\t\tif (typeof currentImageTab === 'boolean') {\r\n\t\t\t//booleans indicate show all or nothing\r\n\t\t\tisMatched = currentImageTab;\r\n\t\t} else if (currentImageTab in customImageTabs) {\r\n\t\t\tvar re = customImageTabs[currentImageTab];\r\n\t\t\tisMatched = re.test(image.text);\r\n\t\t}\r\n\t\t//If false then there is no need to go through the NSFW filter\r\n\t\tif (!isMatched) return false;\r\n\r\n\t\timage.NSFW = false;\r\n\t\tif (module.options.hideNSFW.value) {\r\n\t\t\timage.NSFW = /nsfw/i.test(image.text);\r\n\t\t}\r\n\r\n\t\treturn !image.NSFW;\r\n\t}\r\n\r\n\tfunction findAllImages(elem, isSelfText) {\r\n\t\tscanningForImages = true;\r\n\t\tif (!elem) {\r\n\t\t\telem = document.body;\r\n\t\t}\r\n\t\t// get elements common across all pages first...\r\n\t\t// if we're on a comments page, get those elements too...\r\n\t\tvar commentsre = /comments\\/[\\-\\w\\.\\/]/i;\r\n\t\tvar userre = /user\\/[\\-\\w\\.\\/]/i;\r\n\t\tscanningSelfText = false;\r\n\t\tvar allElements = [];\r\n\t\tif (commentsre.test(location.href) || userre.test(location.href)) {\r\n\t\t\tallElements = elem.querySelectorAll('#siteTable a.title, .expando .usertext-body > div.md a, .content .usertext-body > div.md a');\r\n\t\t} else if (isSelfText) {\r\n\t\t\t// We're scanning newly opened (from an expando) selftext...\r\n\t\t\tallElements = elem.querySelectorAll('.usertext-body > div.md a');\r\n\t\t\tscanningSelfText = true;\r\n\t\t} else if (RESUtils.pageType() === 'wiki'){\r\n\t\t\tallElements = elem.querySelectorAll('.wiki-page-content a');\r\n\t\t} else if (RESUtils.pageType() === 'inbox') {\r\n\t\t\tallElements = elem.querySelectorAll('#siteTable div.entry .md a');\r\n\t\t} else if (RESUtils.pageType() === 'search') {\r\n\t\t\tallElements = elem.querySelectorAll('#siteTable a.title, .contents a.search-link');\r\n\t\t} else {\r\n\t\t\tallElements = elem.querySelectorAll('#siteTable A.title');\r\n\t\t}\r\n\r\n\t\tif (RESUtils.pageType() === 'comments') {\r\n\t\t\tRESUtils.forEachChunked(allElements, 15, 1000, function(element, i, array) {\r\n\t\t\t\tcheckElementForImage(element);\r\n\t\t\t\tif (i >= array.length - 1) {\r\n\t\t\t\t\tscanningSelfText = false;\r\n\t\t\t\t\tscanningForImages = false;\r\n\t\t\t\t\tupdateImageButtons(imageList.length);\r\n\t\t\t\t}\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tArray.prototype.slice.call(allElements).forEach(function(element) {\r\n\t\t\t\tcheckElementForImage(element);\r\n\t\t\t});\r\n\t\t\tscanningSelfText = false;\r\n\t\t\tscanningForImages = false;\r\n\t\t\tupdateImageButtons(imageList.length);\r\n\t\t}\r\n\t}\r\n\r\n\tvar domainModuleMap = {};\r\n\r\n\tfunction generateDomainModuleMap() {\r\n\t\tfor (var m in module.siteModules){\r\n\t\t\tif (!module.siteModules.hasOwnProperty(m)) continue;\r\n\r\n\t\t\tvar _module = module.siteModules[m];\r\n\r\n\t\t\t// Use module id as name if one is not set\r\n\t\t\tif (typeof _module.name === 'undefined') _module.name = m;\r\n\t\t\t// Add default by default\r\n\t\t\tif (_module.name === 'default'){\r\n\t\t\t\tdomainModuleMap['default'] = _module;\r\n\t\t\t\tcontinue;\r\n\t\t\t} else if (_module.name === 'defaultVideo') {\r\n\t\t\t\tdomainModuleMap['defaultVideo'] = _module;\r\n\t\t\t\tcontinue;\r\n\t\t\t} else if (_module.name === 'defaultAudio') {\r\n\t\t\t\tdomainModuleMap['defaultAudio'] = _module;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\t// check if module is enabled\r\n\t\t\tif (siteModuleEnabled(_module.name)) {\r\n\t\t\t\t// if so add its domains to the mapping\r\n\t\t\t\t_module.domains.forEach(function(domain) {\r\n\t\t\t\t\tdomainModuleMap[domainToModuleName(domain)] = _module;\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tfunction siteModuleEnabled(siteName) {\r\n\t\tvar key = 'display ' + siteName;\r\n\t\treturn (typeof module.options[key] === 'undefined') ? true : module.options[key].value;\r\n\t}\r\n\r\n\tfunction domainToModuleName(hostname){\r\n\t\tvar domainStack = hostname.split('.');\r\n\t\t// remove tld\r\n\t\tdomainStack.pop();\r\n\r\n\t\t// Remove second level domain if needed (eg. \"co\" in co.uk)\r\n\t\t// Code inactive as no current site modules need this\r\n\t\t//\r\n\t\t//\tif( ['co'].indexOf(domainStack[domainStack.length-1] ) !== -1){\r\n\t\t//\t\tdomainStack.pop();\r\n\t\t//\t}\r\n\r\n\t\t// Return relevant domain section\r\n\t\treturn domainStack.pop();\r\n\t}\r\n\r\n\tfunction checkElementForImage(elem) {\r\n\t\tif (module.options.hideNSFW.value) {\r\n\t\t\tif (elem.classList.contains('title')) {\r\n\t\t\t\telem.NSFW = elem.parentNode.parentNode.parentNode.classList.contains('over18');\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\telem.NSFW = false;\r\n\t\t}\r\n\t\tvar href = elem.href;\r\n\t\tif ((!elem.classList.contains('imgScanned') && (typeof imagesRevealed[href] === 'undefined' || !module.options.ignoreDuplicates.value || (RESUtils.currentSubreddit('dashboard'))) && href !== null) || scanningSelfText) {\r\n\t\t\telem.classList.add('imgScanned');\r\n\t\t\tdupeAnchors++;\r\n\r\n\t\t\tvar siteFound = module.siteModules['default'].detect(elem.href.toLowerCase(), elem);\r\n\t\t\tif (siteFound) {\r\n\t\t\t\telem.site = 'default';\r\n\t\t\t} else if (module.siteModules['defaultVideo'].detect(elem.href.toLowerCase(), elem)) {\r\n\t\t\t\telem.site = 'defaultVideo';\r\n\t\t\t\tsiteFound = true;\r\n\t\t\t} else if (module.siteModules['defaultAudio'].detect(elem.href.toLowerCase(), elem)) {\r\n\t\t\t\telem.site = 'defaultAudio';\r\n\t\t\t\tsiteFound = true;\r\n\t\t\t} else {\r\n\t\t\t\tvar _module = domainToModuleName(elem.hostname);\r\n\t\t\t\t// Check module exists\r\n\t\t\t\tif (typeof domainModuleMap[_module] !== 'undefined') {\r\n\t\t\t\t\t// If its enabled & detect validates, use it\r\n\t\t\t\t\tif (domainModuleMap[_module].detect(elem.href.toLowerCase(), elem)) {\r\n\t\t\t\t\t\telem.site = _module;\r\n\t\t\t\t\t\tsiteFound = true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (siteFound && !elem.NSFW) {\r\n\t\t\t\timagesRevealed[href] = dupeAnchors;\r\n\t\t\t\tvar siteModule = domainModuleMap[elem.site];\r\n\t\t\t\t$.Deferred().resolve(elem).then(siteModule.handleLink).then(siteModule.handleInfo).\r\n\t\t\t\tthen(createImageExpando, function() {\r\n\t\t\t\t\tconsole.error('showImages: error detecting image expando for ' + elem.href);\r\n\t\t\t\t\tconsole.error.apply(console, arguments);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (!elem.classList.contains('imgScanned')) {\r\n\t\t\tvar textFrag = document.createElement('span');\r\n\t\t\ttextFrag.setAttribute('class', 'RESdupeimg');\r\n\t\t\tremoveRedditExpandoButton(elem);\r\n\t\t\t$(textFrag).html('<a class=\"noKeyNav\" href=\"#img' + parseInt(imagesRevealed[href], 10) + '\" title=\"click to scroll to original\">[RES ignored duplicate link]</a>');\r\n\t\t\tRESUtils.insertAfter(elem, textFrag);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction removeRedditExpandoButton(elem) {\r\n\t\tif (elem.classList.contains('title')) {\r\n\t\t\t// remove the default reddit expando button on post listings\r\n\t\t\t// we actually remove it from the DOM for a number of reasons, including the\r\n\t\t\t// fact that many subreddits style them with display: block !important;, which\r\n\t\t\t// overrides a \"hide\" call here.\r\n\t\t\t$(elem).closest('.entry').find('.expando-button.video:not(.commentImg)').remove();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createImageExpando(elem) {\r\n\t\tif (!elem) return false;\r\n\t\tvar href = elem.href;\r\n\t\tif (!href) return false;\r\n\r\n\t\t// isSelfText indicates if this expando is being created within a\r\n\t\t// selftext expando.\r\n\t\tvar isSelfTextExpando = false;\r\n\t\tif (!$(elem).hasClass('title') && RESUtils.pageType() === 'linklist') {\r\n\t\t\tif ($(elem).closest('.expando').length > 0) {\r\n\t\t\t\tisSelfTextExpando = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tremoveRedditExpandoButton(elem);\r\n\r\n\t\t// This should not be reached in the case of duplicates\r\n\t\telem.name = 'img' + imagesRevealed[href];\r\n\r\n\t\t// expandLink aka the expando button\r\n\t\tvar expandLink = document.createElement('a');\r\n\t\texpandLink.className = 'toggleImage expando-button collapsed collapsedExpando';\r\n\t\tif (elem.type === 'IMAGE') expandLink.className += ' image';\r\n\t\tif (elem.type === 'GALLERY') expandLink.className += ' image gallery';\r\n\t\tif (elem.type === 'TEXT') expandLink.className += ' selftext';\r\n\t\tif (elem.type === 'VIDEO') expandLink.className += ' video';\r\n\t\tif (elem.type === 'IFRAME') expandLink.className += ' video';\r\n\t\tif (elem.type === 'AUDIO') expandLink.className += ' video'; // yes, still class \"video\", that's what reddit uses.\r\n\t\tif (elem.type === 'NOEMBED') expandLink.className += ' ' + elem.expandoClass;\r\n\t\tif (elem.type === 'GENERIC_EXPANDO') expandLink.className +=  elem.expandoClass;\r\n\t\tif (elem.type === 'GALLERY' && elem.src && elem.src.length) expandLink.setAttribute('title', elem.src.length + ' items in gallery');\r\n\t\t$(expandLink).html('&nbsp;');\r\n\t\texpandLink.addEventListener('click', function(e) {\r\n\t\t\t// This event handler must be attached directly to the expando button, not delegated\r\n\t\t\t// to protect it from reddit's delegated handler for clicks on expando button.\r\n\t\t\te.stopPropagation();\r\n\r\n\t\t\te.preventDefault();\r\n\t\t\tmodules['selectedEntry'].select(e.target);\r\n\t\t\trevealImage(e.target, (e.target.classList.contains('collapsedExpando')));\r\n\t\t}, true);\r\n\t\tvar preNode = null;\r\n\t\tif (elem.parentNode.classList.contains('title')) {\r\n\t\t\tpreNode = elem.parentNode;\r\n\t\t\texpandLink.classList.add('linkImg');\r\n\t\t} else {\r\n\t\t\tpreNode = elem;\r\n\t\t\texpandLink.classList.add('commentImg');\r\n\t\t}\r\n\t\tRESUtils.insertAfter(preNode, expandLink);\r\n\t\t/*\r\n\t\t * save the link element for later use since some extensions\r\n\t\t * like web of trust can place other elements in places that\r\n\t\t * confuse the old method\r\n\t\t */\r\n\t\texpandLink.imageLink = elem;\r\n\t\timageList.push(expandLink);\r\n\r\n\t\tif ((scanningSelfText || isSelfTextExpando) && module.options.autoExpandSelfText.value && !elem.doNotExpandInSelfText) {\r\n\t\t\trevealImage(expandLink, true);\r\n\t\t} else if (elem.type === 'IMAGE' || elem.type === 'GALLERY' || (elem.type === 'GENERIC_EXPANDO' && elem.expandOnViewAll === true)) {\r\n\t\t\t// this may have come from an asynchronous call, in which case it'd get missed by findAllImages, so\r\n\t\t\t// if all images are supposed to be visible, expand this link now.\r\n\t\t\trevealImage(expandLink, findImageFilter(expandLink.imageLink));\r\n\t\t}\r\n\t\tif (!scanningForImages) {\r\n\t\t\t// also since this may have come from an asynchronous call, we need to update the view images count.\r\n\t\t\tupdateImageButtons(imageList.length);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction revealImage(expandoButton, showHide) {\r\n\t\t// don't reveal images for invisible buttons (offsetParent is a cheaper way of checking\r\n\t\t// visibility than jquery's .is(':visible'))\r\n\t\tif ((!expandoButton) || (!expandoButton.offsetParent)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\t// showhide = false means hide, true means show!\r\n\r\n\t\tvar imageLink = expandoButton.imageLink,\r\n\t\t\tmediaType, mediaTag, associatedImage;\r\n\r\n\t\tif (typeof domainModuleMap[imageLink.site] === 'undefined') {\r\n\t\t\tconsole.log('something went wrong scanning image from site: ' + imageLink.site);\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (expandoButton.expandoBox && expandoButton.expandoBox.classList.contains('madeVisible')) {\r\n\t\t\tvar isMedia = (imageLink.type === 'AUDIO' || imageLink.type === 'VIDEO' ||\r\n\t\t\t\t\timageLink.subtype === 'VIDEO');\r\n\r\n\t\t\tif (isMedia) {\r\n\t\t\t\tmediaType = (imageLink.subtype === 'VIDEO') ? 'VIDEO' : imageLink.type;\r\n\t\t\t\tmediaTag = expandoButton.expandoBox.querySelector(mediaType);\r\n\t\t\t}\r\n\r\n\t\t\tif (!showHide) {\r\n\t\t\t\t$(expandoButton).removeClass('expanded').addClass('collapsed collapsedExpando');\r\n\t\t\t\texpandoButton.expandoBox.style.display = 'none';\r\n\r\n\t\t\t\tif (isMedia && mediaTag) {\r\n\t\t\t\t\tmediaTag.wasPaused = mediaTag.paused;\r\n\t\t\t\t\tmediaTag.pause();\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t$(expandoButton).addClass('expanded').removeClass('collapsed collapsedExpando');\r\n\t\t\t\texpandoButton.expandoBox.style.display = 'block';\r\n\r\n\t\t\t\tassociatedImage = $(expandoButton).data('associatedImage');\r\n\r\n\t\t\t\tif (associatedImage) {\r\n\t\t\t\t\tsyncPlaceholder(associatedImage);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (isMedia && mediaTag) {\r\n\t\t\t\t\tif (!mediaTag.wasPaused) {\r\n\t\t\t\t\t\tmediaTag.play();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\thandleSRStyleToggleVisibility();\r\n\t\t} else if (showHide) {\r\n\t\t\t//TODO: flash\r\n\t\t\tswitch (imageLink.type) {\r\n\t\t\t\tcase 'IMAGE':\r\n\t\t\t\tcase 'GALLERY':\r\n\t\t\t\t\tif (module.options.convertGifstoGfycat.value) {\r\n\t\t\t\t\t\tvar gif = new RegExp('^(http|https|ftp)://.*\\\\.gif($|/?)');\r\n\t\t\t\t\t\tif (gif.test(imageLink.src)) {\r\n\t\t\t\t\t\t\tif (!imageLink.resChecked) {\r\n\t\t\t\t\t\t\t\timageLink.resChecked = true;\r\n\t\t\t\t\t\t\t\tgenerateGfycatExpando(expandoButton, {autoplay: true, loop: true, muted: true});\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tgenerateImageExpando(expandoButton);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'TEXT':\r\n\t\t\t\t\tgenerateTextExpando(expandoButton);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'IFRAME':\r\n\t\t\t\t\tgenerateIframeExpando(expandoButton);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'VIDEO':\r\n\t\t\t\t\tgenerateVideoExpando(expandoButton, imageLink.expandoOptions);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'AUDIO':\r\n\t\t\t\t\tgenerateAudioExpando(expandoButton);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'NOEMBED':\r\n\t\t\t\t\tgenerateNoEmbedExpando(expandoButton);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'GENERIC_EXPANDO':\r\n\t\t\t\t\tgenerateGenericExpando(expandoButton, imageLink.expandoOptions);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tupdateParentHeight(expandoButton);\r\n\t}\r\n\r\n\tfunction generateImageExpando(expandoButton) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\t\tvar which = imageLink.galleryStart || 0;\r\n\r\n\t\tvar imgDiv = document.createElement('div');\r\n\t\timgDiv.classList.add('madeVisible');\r\n\t\timgDiv.currentImage = which;\r\n\t\timgDiv.sources = [];\r\n\r\n\t\t// Test for a single image or an album/array of image\r\n\t\tif (Array.isArray(imageLink.src)) {\r\n\t\t\timgDiv.sources = imageLink.src;\r\n\r\n\t\t\t// Also preload images for an album if the option is on.\r\n\t\t\tif (module.options.preloadImages.value) {\r\n\t\t\t\tpreloadImages(imageLink.src, 0);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Only the image is left to display, pack it like a single-image album with no caption or title\r\n\t\t\tvar singleImage = {\r\n\t\t\t\tsrc: imageLink.src,\r\n\t\t\t\thref: imageLink.href\r\n\t\t\t};\r\n\t\t\timgDiv.sources[0] = singleImage;\r\n\t\t}\r\n\r\n\t\tvar header;\r\n\t\tif ('imageTitle' in imageLink) {\r\n\t\t\theader = document.createElement('h3');\r\n\t\t\theader.classList.add('imgTitle');\r\n\t\t\t$(header).safeHtml(imageLink.imageTitle);\r\n\t\t\timgDiv.appendChild(header);\r\n\t\t}\r\n\r\n\t\tif ('imgCaptions' in imageLink) {\r\n\t\t\tvar captions = document.createElement('div');\r\n\t\t\tcaptions.className = 'imgCaptions';\r\n\t\t\t$(captions).safeHtml(imageLink.caption);\r\n\t\t\timgDiv.appendChild(captions);\r\n\t\t}\r\n\r\n\t\tif ('credits' in imageLink) {\r\n\t\t\tvar credits = document.createElement('div');\r\n\t\t\tcredits.className = 'imgCredits';\r\n\t\t\t$(credits).safeHtml(imageLink.credits);\r\n\t\t\timgDiv.appendChild(credits);\r\n\t\t}\r\n\r\n\t\tswitch (imageLink.type) {\r\n\t\t\tcase 'GALLERY':\r\n\t\t\t\tvar loadAllInAlbum = module.options.loadAllInAlbum.value;\r\n\t\t\t\tvar dontLoadAlbumsBiggerThan = parseInt(module.options.dontLoadAlbumsBiggerThan.value, 10) || 0;\r\n\t\t\t\tif (loadAllInAlbum && (dontLoadAlbumsBiggerThan <= 0 || imgDiv.sources.length <= dontLoadAlbumsBiggerThan)) {\r\n\t\t\t\t\tif (imgDiv.sources.length > 1) {\r\n\t\t\t\t\t\tvar albumLength = ' (' + imgDiv.sources.length + ' images)';\r\n\t\t\t\t\t\tif (header) {\r\n\t\t\t\t\t\t\t$(header).append(albumLength);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tfor (var imgNum = 0; imgNum < imgDiv.sources.length; imgNum++) {\r\n\t\t\t\t\t\taddImage(imgDiv, imgNum);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// If we're using the traditional album view, add the controls then fall through to add the IMAGE\r\n\t\t\t\t\tvar controlWrapper = document.createElement('div');\r\n\t\t\t\t\tcontrolWrapper.className = 'RESGalleryControls';\r\n\r\n\t\t\t\t\tvar leftButton = document.createElement('a');\r\n\t\t\t\t\tleftButton.className = 'previous noKeyNav';\r\n\t\t\t\t\tleftButton.addEventListener('click', function(e) {\r\n\t\t\t\t\t\tvar topWrapper = e.target.parentElement.parentElement;\r\n\t\t\t\t\t\tif (topWrapper.currentImage === 0) {\r\n\t\t\t\t\t\t\ttopWrapper.currentImage = topWrapper.sources.length - 1;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttopWrapper.currentImage -= 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tadjustGalleryDisplay(topWrapper);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tcontrolWrapper.appendChild(leftButton);\r\n\r\n\t\t\t\t\tvar posLabel = document.createElement('span');\r\n\t\t\t\t\tposLabel.className = 'RESGalleryLabel';\r\n\t\t\t\t\tvar niceWhich = ((which + 1 < 10) && (imgDiv.sources.length >= 10)) ? '0' + (which + 1) : (which + 1);\r\n\t\t\t\t\tif (imgDiv.sources.length) {\r\n\t\t\t\t\t\tposLabel.textContent = niceWhich + ' of ' + imgDiv.sources.length;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tposLabel.textContent = 'Whoops, this gallery seems to be empty.';\r\n\t\t\t\t\t}\r\n\t\t\t\t\tcontrolWrapper.appendChild(posLabel);\r\n\r\n\t\t\t\t\tif (loadAllInAlbum && dontLoadAlbumsBiggerThan > 0 && dontLoadAlbumsBiggerThan < imgDiv.sources.length) {\r\n\t\t\t\t\t\tvar largeAlbum = $('<span />').attr('title', 'Album has more than ' + dontLoadAlbumsBiggerThan + ' images. \\nClick to adjust settings.');\r\n\t\t\t\t\t\tvar largeAlbumSettings = modules['settingsNavigation'].makeUrlHashLink('showImages', 'dontLoadAlbumsBiggerThan', '*', 'RESGalleryLargeInfo');\r\n\t\t\t\t\t\tlargeAlbum.append(largeAlbumSettings);\r\n\r\n\t\t\t\t\t\tlargeAlbum.appendTo(controlWrapper);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tvar rightButton = document.createElement('a');\r\n\t\t\t\t\trightButton.className = 'next noKeyNav';\r\n\t\t\t\t\trightButton.addEventListener('click', function(e) {\r\n\t\t\t\t\t\tvar topWrapper = e.target.parentElement.parentElement;\r\n\t\t\t\t\t\tif (topWrapper.currentImage == topWrapper.sources.length - 1) {\r\n\t\t\t\t\t\t\ttopWrapper.currentImage = 0;\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\ttopWrapper.currentImage += 1;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tadjustGalleryDisplay(topWrapper);\r\n\t\t\t\t\t});\r\n\t\t\t\t\tcontrolWrapper.appendChild(rightButton);\r\n\r\n\t\t\t\t\tif (!imgDiv.sources.length) {\r\n\t\t\t\t\t\t$(leftButton).css('visibility', 'hidden');\r\n\t\t\t\t\t\t$(rightButton).css('visibility', 'hidden');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\timgDiv.appendChild(controlWrapper);\r\n\t\t\t\t}\r\n\t\t\t\t/* falls through */\r\n\t\t\tcase 'IMAGE':\r\n\t\t\t\taddImage(imgDiv, which, this);\r\n\t\t}\r\n\r\n\t\tfunction addImage(container, sourceNumber) {\r\n\t\t\tvar sourceImage = container.sources[sourceNumber];\r\n\r\n\t\t\tvar paragraph = document.createElement('p');\r\n\r\n\t\t\tif (!sourceImage) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif ('title' in sourceImage) {\r\n\t\t\t\tvar imageTitle = document.createElement('h4');\r\n\t\t\t\timageTitle.className = 'imgCaptions';\r\n\t\t\t\t$(imageTitle).safeHtml(sourceImage.title);\r\n\t\t\t\tparagraph.appendChild(imageTitle);\r\n\t\t\t}\r\n\r\n\t\t\tif ('caption' in sourceImage) {\r\n\t\t\t\tvar imageCaptions = document.createElement('div');\r\n\t\t\t\timageCaptions.className = 'imgCaptions';\r\n\t\t\t\t$(imageCaptions).safeHtml(sourceImage.caption);\r\n\t\t\t\tparagraph.appendChild(imageCaptions);\r\n\t\t\t}\r\n\r\n\t\t\tvar imageAnchor = document.createElement('a');\r\n\t\t\timageAnchor.classList.add('madeVisible');\r\n\t\t\timageAnchor.href = sourceImage.src;\r\n\t\t\tif (module.options.openInNewWindow.value) {\r\n\t\t\t\timageAnchor.target = '_blank';\r\n\t\t\t}\r\n\t\t\tvar media = (/*sourceImage.expandoOptions && sourceImage.expandoOptions.generate ||*/ generateImage.bind(this, sourceImage))();\r\n\r\n\t\t\t$(expandoButton).data('associatedImage', media);\r\n\t\t\timageLink.media = media;\r\n\t\t\timageAnchor.appendChild(media);\r\n\t\t\tmodule.makeMediaZoomable(media);\r\n\t\t\tmodule.makeMediaMovable(media);\r\n\t\t\ttrackMediaLoad(imageLink, media);\r\n\t\t\tparagraph.appendChild(imageAnchor);\r\n\r\n\t\t\tcontainer.appendChild(paragraph);\r\n\t\t}\r\n\r\n\t\tfunction generateImage(sourceImage) {\r\n\t\t\tvar image = document.createElement('img');\r\n\t\t\t//Unfortunately it is impossible to use a global event handler for these.\r\n\t\t\timage.onerror = function() {\r\n\t\t\t\timage.classList.add('RESImageError');\r\n\t\t\t};\r\n\t\t\timage.onload = function() {\r\n\t\t\t\timage.classList.remove('RESImageError');\r\n\t\t\t\tif (module.options.displayOriginalResolution.value && this.naturalWidth && this.naturalHeight) {\r\n\t\t\t\t\tthis.title = this.naturalWidth + ' × ' + this.naturalHeight + ' px';\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\timage.classList.add('RESImage');\r\n\t\t\timage.id = 'RESImage-' + RESUtils.randomHash();\r\n\t\t\timage.src = sourceImage.src;\r\n\t\t\timage.style.maxWidth = module.options.maxWidth.value + 'px';\r\n\t\t\timage.style.maxHeight = module.options.maxHeight.value + 'px';\r\n\t\t\treturn image;\r\n\t\t}\r\n\r\n\t\t//Adjusts the images for the gallery navigation buttons as well as the \"n of m\" display.\r\n\r\n\t\tfunction adjustGalleryDisplay(topLevel) {\r\n\t\t\tvar source = topLevel.sources[topLevel.currentImage];\r\n\t\t\tvar image = topLevel.querySelector('img.RESImage');\r\n\t\t\tvar imageAnchor = image.parentElement;\r\n\t\t\tvar paragraph = imageAnchor.parentElement;\r\n\r\n\t\t\t// if it's a gif file, blank out the image so there's no confusion about loading...\r\n\t\t\tif (image.src.toLowerCase().substr(-4) === '.gif') {\r\n\t\t\t\timage.src = transparentGif;\r\n\t\t\t}\r\n\t\t\timageAnchor.classList.add('csspinner');\r\n\t\t\timageAnchor.classList.add('ringed');\r\n\r\n\t\t\t// set 'loaded' to false since we're about to load a new image\r\n\t\t\t$(image).data('loaded', false);\r\n\t\t\timage.src = source.src;\r\n\t\t\timageAnchor.href = source.href || imageLink.href;\r\n\t\t\tvar paddedImageNumber = ((topLevel.currentImage + 1 < 10) && (imgDiv.sources.length >= 10)) ? '0' + (topLevel.currentImage + 1) : topLevel.currentImage + 1;\r\n\t\t\tif (imgDiv.sources.length) {\r\n\t\t\t\ttopLevel.querySelector('.RESGalleryLabel').textContent = (paddedImageNumber + ' of ' + imgDiv.sources.length);\r\n\t\t\t} else {\r\n\t\t\t\ttopLevel.querySelector('.RESGalleryLabel').textContent = 'Whoops, this gallery seems to be empty.';\r\n\t\t\t}\r\n\t\t\tif (topLevel.currentImage === 0) {\r\n\t\t\t\tleftButton.classList.add('end');\r\n\t\t\t\trightButton.classList.remove('end');\r\n\t\t\t} else if (topLevel.currentImage === topLevel.sources.length - 1) {\r\n\t\t\t\tleftButton.classList.remove('end');\r\n\t\t\t\trightButton.classList.add('end');\r\n\t\t\t} else {\r\n\t\t\t\tleftButton.classList.remove('end');\r\n\t\t\t\trightButton.classList.remove('end');\r\n\t\t\t}\r\n\r\n\t\t\t$(paragraph).find('.imgCaptions').empty();\r\n\t\t\tvar imageTitle = paragraph.querySelector('h4.imgCaptions');\r\n\t\t\tif (imageTitle) $(imageTitle).safeHtml(source.title);\r\n\t\t\tvar imageCaptions = paragraph.querySelector('div.imgCaptions');\r\n\t\t\tif (imageCaptions) $(imageCaptions).safeHtml(source.caption);\r\n\t\t}\r\n\r\n\t\texpandoButton.expandoBox = imgDiv;\r\n\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, imgDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(imgDiv);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Recursively loads the images synchronously.\r\n\t */\r\n\tfunction preloadImages(srcs, i) {\r\n\t\tvar _i = i,\r\n\t\t\timg = new Image();\r\n\t\timg.onload = img.onerror = function() {\r\n\t\t\t_i++;\r\n\t\t\tif (typeof srcs[_i] === 'undefined') {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tpreloadImages(srcs, _i);\r\n\t\t};\r\n\t\timg.src = srcs[i].src;\r\n\t}\r\n\r\n\tfunction generateIframeExpando(expandoButton) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\timageLink.wrapperDiv = wrapperDiv;\r\n\r\n\t\twrapperDiv.className = 'madeVisible';\r\n\t\tvar iframeNode = document.createElement('iframe');\r\n\t\tiframeNode.setAttribute('width', imageLink.getAttribute('data-width') || '640');\r\n\t\tiframeNode.setAttribute('height', imageLink.getAttribute('data-height') || '360');\r\n\t\tiframeNode.setAttribute('src', imageLink.getAttribute('data-embed'));\r\n\t\tiframeNode.setAttribute('frameborder', '0');\r\n\t\tiframeNode.setAttribute('allowfullscreen', '');\r\n\t\twrapperDiv.appendChild(iframeNode);\r\n\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\r\n\t\texpandoButton.expandoBox = wrapperDiv;\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\texpandoButton.addEventListener('click', function(e) {\r\n\t\t\tvar msg = null;\r\n\t\t\tif (e.target.className.indexOf('expanded') === -1) {\r\n\t\t\t\tmsg = imageLink.getAttribute('data-pause');\r\n\t\t\t} else {\r\n\t\t\t\tmsg = imageLink.getAttribute('data-play');\r\n\t\t\t}\r\n\t\t\t// Pass message to iframe\r\n\t\t\tif (msg !== null) $(wrapperDiv).children('iframe')[0].contentWindow.postMessage(msg, '*');\r\n\t\t}, false);\r\n\r\n\t\t// Pause if comment (or any parent of comment) is collapsed\r\n\t\tif (RESUtils.pageType() == 'comments') {\r\n\t\t\t$(expandoButton).parents('.comment').find('> .entry .tagline > .expand').click(function(){\r\n\t\t\t\t$(wrapperDiv).children('iframe')[0].contentWindow.postMessage(imageLink.getAttribute('data-pause'), '*');\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\t// Delete iframe on close of built-in reddit expando's (if this is part of a linklist page), as they get regenerated on open anyway\r\n\t\tif (RESUtils.pageType() == 'linklist') {\r\n\t\t\t$(expandoButton).closest('div.entry').children('.expando-button:first').click(function(){\r\n\t\t\t\t$(wrapperDiv).children('iframe').remove();\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction generateTextExpando(expandoButton) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'usertext';\r\n\t\timageLink.wrapperDiv = wrapperDiv;\r\n\r\n\t\tvar imgDiv = document.createElement('div');\r\n\t\timgDiv.className = 'madeVisible usertext-body';\r\n\r\n\t\tvar header = document.createElement('h3');\r\n\t\theader.className = 'imgTitle';\r\n\t\t$(header).safeHtml(imageLink.imageTitle);\r\n\t\timgDiv.appendChild(header);\r\n\r\n\t\tvar text = document.createElement('div');\r\n\t\ttext.className = 'md';\r\n\r\n\t\t// filter out iframes, as they will not survive safeHTML\r\n\t\t// TODO: make safeHTML handle iframes acceptably?\r\n\t\timageLink.src = imageLink.src.replace(/<iframe/ig, '&lt;iframe');\r\n\r\n\t\t$(text).safeHtml(imageLink.src);\r\n\t\timgDiv.appendChild(text);\r\n\r\n\t\tvar captions = document.createElement('div');\r\n\t\tcaptions.className = 'imgCaptions';\r\n\t\t$(captions).safeHtml(imageLink.caption);\r\n\t\timgDiv.appendChild(captions);\r\n\r\n\t\tif ('credits' in imageLink) {\r\n\t\t\tvar credits = document.createElement('div');\r\n\t\t\tcredits.className = 'imgCredits';\r\n\t\t\t$(credits).safeHtml(imageLink.credits);\r\n\t\t\timgDiv.appendChild(credits);\r\n\t\t}\r\n\r\n\t\twrapperDiv.appendChild(imgDiv);\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\t\texpandoButton.expandoBox = imgDiv;\r\n\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\t//TODO: Decide how to handle history for this.\r\n\t\t//Selfposts already don't mark it, so either don't bother or add marking for selfposts.\r\n\t}\r\n\r\n\tfunction generateVideoExpando(expandoButton, options) {\r\n\t\tvar mediaLink = expandoButton.imageLink;\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'madeVisible';\r\n\t\tmediaLink.wrapperDiv = wrapperDiv;\r\n\r\n\t\tvar playerDiv = document.createElement('div');\r\n\t\tplayerDiv.className = 'res-player';\r\n\r\n\t\twrapperDiv.appendChild(playerDiv);\r\n\r\n\r\n\t\tvar video = document.createElement('video'),\r\n\t\t\t$video = $(video);\r\n\t\tvideo.setAttribute('controls', '');\r\n\t\tvideo.setAttribute('preload', '');\r\n\t\tif (options) {\r\n\t\t\tif (options.autoplay) {\r\n\t\t\t\tvideo.setAttribute('autoplay', '');\r\n\t\t\t}\r\n\t\t\tif (options.muted) {\r\n\t\t\t\tvideo.setAttribute('muted', '');\r\n\t\t\t}\r\n\t\t\tif (options.loop) {\r\n\t\t\t\tvideo.setAttribute('loop', '');\r\n\t\t\t}\r\n\t\t\tif (options.poster) {\r\n\t\t\t\tvideo.setAttribute('poster', options.poster);\r\n\t\t\t}\r\n\t\t}\r\n\t\tvideo.style.maxWidth = module.options.maxWidth.value + 'px';\r\n\t\tvideo.style.maxHeight = module.options.maxHeight.value + 'px';\r\n\r\n\t\tvar sources = $(mediaLink).data('sources'),\r\n\t\t\tfallback = $(mediaLink).data('fallback'),\r\n\t\t\toriginal = $(mediaLink).data('original'),\r\n\t\t\tsource, sourceEle;\r\n\r\n\t\tfor (var i = 0, len = sources.length; i < len; i++) {\r\n\t\t\tsource = sources[i];\r\n\t\t\tsourceEle = document.createElement('source');\r\n\t\t\tsourceEle.src = source.file;\r\n\t\t\tsourceEle.type = source.type;\r\n\t\t\tif (fallback && i === len - 1) {\r\n\t\t\t\t$(sourceEle).data('fallback', fallback);\r\n\t\t\t\t$(sourceEle).data('original', original);\r\n\t\t\t\tsourceEle.addEventListener('error', function(e) {\r\n\t\t\t\t\tvar fallbackLink = document.createElement('a'),\r\n\t\t\t\t\t\tfallbackImg = document.createElement('img'),\r\n\t\t\t\t\t\tvid = e.target.parentNode,\r\n\t\t\t\t\t\tplayer = vid.parentNode;\r\n\r\n\t\t\t\t\tfallbackImg.src = $(e.target).data('fallback');\r\n\t\t\t\t\tfallbackImg.class = 'RESImage';\r\n\t\t\t\t\tfallbackLink.href = $(e.target).data('original');\r\n\t\t\t\t\tfallbackLink.target = '_blank';\r\n\t\t\t\t\tfallbackLink.appendChild(fallbackImg);\r\n\r\n\t\t\t\t\tplayer.parentNode.replaceChild(fallbackLink, player);\r\n\t\t\t\t\tmodule.makeMediaZoomable(fallbackImg);\r\n\t\t\t\t\tmodule.makeMediaMovable(fallbackImg);\r\n\t\t\t\t}, false);\r\n\t\t\t}\r\n\t\t\t$video.append(sourceEle);\r\n\t\t}\r\n\r\n\t\tplayerDiv.appendChild(video);\r\n\r\n\t\texpandoButton.expandoBox = wrapperDiv;\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\r\n\t\tif (mediaLink.onExpandData) {\r\n\t\t\tmediaLink.onExpandData.siteMod.onExpand(mediaLink);\r\n\t\t}\r\n\r\n\r\n\t\tmodule.makeMediaZoomable(video);\r\n\t\tmodule.makeMediaMovable(video);\r\n\t\ttrackMediaLoad(mediaLink, video);\r\n\t}\r\n\r\n\tfunction generateAudioExpando(expandoButton, options) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'usertext';\r\n\r\n\t\tvar imgDiv = document.createElement('div');\r\n\t\timgDiv.className = 'madeVisible usertext-body';\r\n\r\n\t\tvar header = document.createElement('h3');\r\n\t\theader.className = 'imgTitle';\r\n\t\t$(header).safeHtml(imageLink.imageTitle);\r\n\t\timgDiv.appendChild(header);\r\n\r\n\t\tvar audio = document.createElement('audio');\r\n\t\taudio.setAttribute('controls', '');\r\n\t\tif (options) {\r\n\t\t\tif (options.autoplay) {\r\n\t\t\t\taudio.setAttribute('autoplay', '');\r\n\t\t\t}\r\n\t\t\tif (options.muted) {\r\n\t\t\t\taudio.setAttribute('muted', '');\r\n\t\t\t}\r\n\t\t\tif (options.loop) {\r\n\t\t\t\taudio.setAttribute('loop', '');\r\n\t\t\t}\r\n\t\t}\r\n\t\t// TODO: add mute/unmute control, play/pause control.\r\n\r\n\t\tvar sources = $(imageLink).data('sources'),\r\n\t\t\tsource, sourceEle;\r\n\r\n\t\tfor (var i = 0, len = sources.length; i < len; i++) {\r\n\t\t\tsource = sources[i];\r\n\t\t\tsourceEle = document.createElement('source');\r\n\t\t\tsourceEle.src = source.file;\r\n\t\t\tsourceEle.type = source.type;\r\n\t\t\t$(audio).append(sourceEle);\r\n\t\t}\r\n\r\n\t\timgDiv.appendChild(audio);\r\n\r\n\t\tif ('credits' in imageLink) {\r\n\t\t\tvar credits = document.createElement('div');\r\n\t\t\tcredits.className = 'imgCredits';\r\n\t\t\t$(credits).safeHtml(imageLink.credits);\r\n\t\t\timgDiv.appendChild(credits);\r\n\t\t}\r\n\r\n\t\twrapperDiv.appendChild(imgDiv);\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\t\texpandoButton.expandoBox = imgDiv;\r\n\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\tif (imageLink.onExpandData) {\r\n\t\t\timageLink.onExpandData.siteMod.onExpand(imageLink);\r\n\t\t}\r\n\r\n\t\ttrackMediaLoad(imageLink, audio);\r\n\t}\r\n\r\n\tfunction addGfycatVideo(info, expandoButton, options) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\t\timageLink.type = 'VIDEO';\r\n\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'usertext';\r\n\r\n\t\tvar imgDiv = document.createElement('div');\r\n\t\timgDiv.className = 'madeVisible usertext-body';\r\n\r\n\t\tvar header = document.createElement('h3');\r\n\t\theader.className = 'imgTitle';\r\n\t\t$(header).safeHtml(imageLink.imageTitle);\r\n\t\timgDiv.appendChild(header);\r\n\r\n\t\tvar template = RESTemplates.getSync('GfycatUI');\r\n\t\tvar videoData = {\r\n\t\t\tloop: true,\r\n\t\t\tautoplay: true,\r\n\t\t\tmuted: true,\r\n\t\t\tdirecturl: info.url\r\n\t\t};\r\n\r\n\t\tvideoData.poster = location.protocol + '//thumbs.gfycat.com/'+info.gfyName+'-poster.jpg';\r\n\t\tif (location.protocol === 'https:') {\r\n\t\t\tinfo.webmUrl = info.webmUrl.replace('http:', 'https:');\r\n\t\t\tinfo.mp4Url = info.mp4Url.replace('http:', 'https:');\r\n\t\t}\r\n\t\tvideoData.sources = [\r\n\t\t\t{\r\n\t\t\t\t'source': info.webmUrl,\r\n\t\t\t\t'type': 'video/webm',\r\n\t\t\t\t'class': 'gfyRwebmsrc'\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t'source': info.mp4Url,\r\n\t\t\t\t'type': 'video/mp4',\r\n\t\t\t\t'class': 'gfyRmp4src'\r\n\t\t\t}\r\n\t\t];\r\n\t\tvar element = template.html(videoData)[0],\r\n\t\t\tvideo = element.querySelector('video');\r\n\r\n\t\tnew gfyObject(element, info.url, info.frameRate);\r\n\r\n\t\timgDiv.appendChild(element);\r\n\r\n\t\tif ('credits' in imageLink) {\r\n\t\t\tvar credits = document.createElement('div');\r\n\t\t\tcredits.className = 'imgCredits';\r\n\t\t\t$(credits).safeHtml(imageLink.credits);\r\n\t\t\timgDiv.appendChild(credits);\r\n\t\t}\r\n\r\n\t\twrapperDiv.appendChild(imgDiv);\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\t\texpandoButton.expandoBox = imgDiv;\r\n\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\r\n\t\tmodule.makeMediaZoomable(video);\r\n\t\tsyncPlaceholder(video);\r\n\t\ttrackMediaLoad(imageLink, video);\r\n\t}\r\n\r\n\tfunction handleGfycatSources(name, expandoButton, options) {\r\n\t\tvar xhr = new XMLHttpRequest();\r\n\t\txhr.open('GET', location.protocol + '//gfycat.com/cajax/get/' + name);\r\n\r\n\t\txhr.onload = function(e) {\r\n\t\t\tvar json = JSON.parse(e.target.responseText);\r\n\r\n\t\t\taddGfycatVideo(json.gfyItem, expandoButton, options);\r\n\t\t};\r\n\r\n\t\txhr.onerror = function() {\r\n\t\t\tgenerateImageExpando(expandoButton);\r\n\t\t};\r\n\r\n\t\txhr.send();\r\n\t}\r\n\r\n\tfunction generateGfycatExpando(expandoButton, options) {\r\n\t\tvar apiURL = location.protocol + '//upload.gfycat.com/transcodeRelease?fetchUrl=' + encodeURIComponent(expandoButton.imageLink.src);\r\n\r\n\t\tvar xhr = new XMLHttpRequest();\r\n\t\txhr.open('GET', apiURL);\r\n\r\n\t\txhr.onload = function(e) {\r\n\t\t\ttry {\r\n\t\t\t\tvar json = JSON.parse(e.target.responseText);\r\n\t\t\t\tif ('gfyName' in json) {\r\n\t\t\t\t\thandleGfycatSources(json.gfyName, expandoButton, options);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tgenerateImageExpando(expandoButton);\r\n\t\t\t\t}\r\n\t\t\t} catch (error) {\r\n\t\t\t\tgenerateImageExpando(expandoButton);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\txhr.onerror = function() {\r\n\t\t\tgenerateImageExpando(expandoButton);\r\n\t\t};\r\n\r\n\t\txhr.send();\r\n\t}\r\n\r\n\tfunction generateGenericExpando(expandoButton, options) {\r\n\t\tvar mediaLink = expandoButton.imageLink;\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'usertext';\r\n\t\tmediaLink.wrapperDiv = wrapperDiv;\r\n\r\n\t\tvar mediaDiv = document.createElement('div');\r\n\t\tmediaDiv.className = 'madeVisible usertext-body';\r\n\r\n\t\tvar element = options.generate(options);\r\n\t\tmediaDiv.appendChild(element);\r\n\t\twrapperDiv.appendChild(mediaDiv);\r\n\r\n\t\texpandoButton.addEventListener('click', function(e) {\r\n\t\t\tif (options.media.blob_type === 'video' || options.media.blob_type === 'audio') {\r\n\t\t\t\tvar media = wrapperDiv.querySelector('video, audio');\r\n\t\t\t\tif (expandoButton.classList.contains('expanded')) {\r\n\t\t\t\t\tif (!media.wasPaused) {\r\n\t\t\t\t\t\tmedia.play();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmedia.wasPaused = media.paused;\r\n\t\t\t\t\tmedia.pause();\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, false);\r\n\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\r\n\t\tvar video = element.querySelector('video');\r\n\t\tif (options.media.blob_type === 'video') {\r\n\t\t\tvideo.style.maxWidth = $(element).closest('.entry').width() + 'px';\r\n\t\t}\r\n\r\n\t\texpandoButton.expandoBox = mediaDiv;\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\t\t$(expandoButton).data('associatedImage', video || element);\r\n\r\n\t\tif (video) {\r\n\t\t\tmodule.makeMediaZoomable(video);\r\n\t\t\tsyncPlaceholder(video);\r\n\t\t}\r\n\r\n\t\tif (mediaLink.onExpandData) {\r\n\t\t\tmediaLink.onExpandData.siteMod.onExpand(mediaLink);\r\n\t\t}\r\n\r\n\t\ttrackMediaLoad(mediaLink, element);\r\n\t}\r\n\r\n\tfunction generateNoEmbedExpando(expandoButton) {\r\n\t\tvar imageLink = expandoButton.imageLink,\r\n\t\t\tapiURL = '//noembed.com/embed?url=' + encodeURIComponent(imageLink.src),\r\n\t\t\tdef = $.Deferred();\r\n\r\n\t\tRESEnvironment.ajax({\r\n\t\t\tmethod: 'GET',\r\n\t\t\turl: apiURL,\r\n\t\t\t// aggressiveCache: true,\r\n\t\t\tonload: function(response) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar json = JSON.parse(response.responseText);\r\n\t\t\t\t\thandleNoEmbedQuery(expandoButton, json);\r\n\t\t\t\t\tdef.resolve(expandoButton, json);\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tdef.reject();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonerror: function(response) {\r\n\t\t\t\tdef.reject();\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handleNoEmbedQuery(expandoButton, response) {\r\n\t\tvar imageLink = expandoButton.imageLink;\r\n\r\n\t\tvar wrapperDiv = document.createElement('div');\r\n\t\twrapperDiv.className = 'usertext';\r\n\t\timageLink.wrapperDiv = wrapperDiv;\r\n\r\n\t\tvar noEmbedFrame = document.createElement('iframe');\r\n\t\t// not all noEmbed responses have a height and width, so if\r\n\t\t// this siteMod has a width and/or height set, use them.\r\n\t\tif (imageLink.siteMod.width) {\r\n\t\t\tnoEmbedFrame.setAttribute('width', imageLink.siteMod.width);\r\n\t\t}\r\n\t\tif (imageLink.siteMod.height) {\r\n\t\t\tnoEmbedFrame.setAttribute('height', imageLink.siteMod.height);\r\n\t\t}\r\n\t\tif (imageLink.siteMod.urlMod) {\r\n\t\t\tnoEmbedFrame.setAttribute('src', imageLink.siteMod.urlMod(response.url));\r\n\t\t}\r\n\t\tfor (var key in response) {\r\n\t\t\tswitch (key) {\r\n\t\t\t\tcase 'url':\r\n\t\t\t\t\tif (!noEmbedFrame.hasAttribute('src')) {\r\n\t\t\t\t\t\tnoEmbedFrame.setAttribute('src', response[key]);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'width':\r\n\t\t\t\t\tnoEmbedFrame.setAttribute('width', response[key]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'height':\r\n\t\t\t\t\tnoEmbedFrame.setAttribute('height', response[key]);\r\n\t\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t\tnoEmbedFrame.className = 'madeVisible usertext-body';\r\n\r\n\t\twrapperDiv.appendChild(noEmbedFrame);\r\n\t\tif (expandoButton.classList.contains('commentImg')) {\r\n\t\t\tRESUtils.insertAfter(expandoButton, wrapperDiv);\r\n\t\t} else {\r\n\t\t\texpandoButton.parentNode.appendChild(wrapperDiv);\r\n\t\t}\r\n\r\n\t\texpandoButton.expandoBox = noEmbedFrame;\r\n\r\n\t\texpandoButton.classList.remove('collapsedExpando');\r\n\t\texpandoButton.classList.remove('collapsed');\r\n\t\texpandoButton.classList.add('expanded');\r\n\t}\r\n\r\n\tvar visits = [];\r\n\tvar sendVisitsThrottle;\r\n\r\n\tfunction trackVisit(link) {\r\n\t\tvar $link = $(link).closest('.thing'),\r\n\t\t\tfullname;\r\n\r\n\t\tif (BrowserDetect.isChrome() && chrome.extension.inIncognitoContext) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif ($link.hasClass('visited')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tfullname = $link.data('fullname');\r\n\t\tvisits.push(fullname);\r\n\r\n\t\tclearTimeout(sendVisitsThrottle);\r\n\t\tsendVisitsThrottle = setTimeout(sendVisits, 1000);\r\n\t}\r\n\r\n\tfunction sendVisits() {\r\n\t\tvar modhash = RESUtils.loggedInUserHash(),\r\n\t\t\tdata = visits.join(',');\r\n\r\n\t\t$.ajax({\r\n\t\t\ttype: 'POST',\r\n\t\t\turl: '/api/store_visits',\r\n\t\t\theaders: {\r\n\t\t\t\t'X-Modhash': modhash\r\n\t\t\t},\r\n\t\t\tdata: {\r\n\t\t\t\t'links': data\r\n\t\t\t},\r\n\t\t\tsuccess: function() {\r\n\t\t\t\t// clear the queue.\r\n\t\t\t\tvisits = [];\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction trackMediaLoad(link, media) {\r\n\t\tif (module.options.markVisited.value) {\r\n\t\t\t// also use reddit's mechanism for storing visited links if user has gold.\r\n\t\t\tif ($('body').hasClass('gold')) {\r\n\t\t\t\ttrackVisit(link);\r\n\t\t\t}\r\n\t\t\tvar isNSFW = $(link).closest('.thing').is('.over18');\r\n\t\t\tvar sfwMode = module.options['sfwHistory'].value;\r\n\r\n\t\t\tif ((BrowserDetect.isChrome()) || (BrowserDetect.isFirefox())) {\r\n\t\t\t\tonLoad();\r\n\t\t\t} else {\r\n\t\t\t\tmedia.addEventListener('load', onLoad, false);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfunction onLoad() {\r\n\t\t\tvar url = link.historyURL || link.href;\r\n\t\t\tif (!isNSFW || sfwMode !== 'none') link.classList.add('visited');\r\n\t\t\tif (!isNSFW || sfwMode === 'add') {\r\n\t\t\t\timageTrackStack.push(url);\r\n\t\t\t\tif (imageTrackStack.length === 1) setTimeout(imageTrackShift, 300);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmedia.addEventListener('load', function(e) {\r\n\t\t\t$(e.target).data('loaded', true);\r\n\t\t\t$(e.target).closest('a.madeVisible').removeClass('csspinner');\r\n\t\t\thandleSRStyleToggleVisibility(e.target);\r\n\t\t}, false);\r\n\t}\r\n\r\n\tfunction imageTrackShift() {\r\n\t\tvar url = imageTrackStack.shift();\r\n\t\tif (typeof url === 'undefined') {\r\n\t\t\thandleSRStyleToggleVisibility();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tRESEnvironment.addURLToHistory(url);\r\n\t\timageTrackShift();\r\n\t}\r\n\r\n\tvar dragTargetData = {\r\n\t\t//numbers just picked as sane initialization values\r\n\t\timageWidth: 100,\r\n\t\tdiagonal: 0, //zero to represent the state where no the mouse button is not down\r\n\t\tdragging: false\r\n\t};\r\n\tvar moveTargetData = {\r\n\t\tmoving: false, // Whether the image should move with the mouse or not\r\n\t\tmouseLastPos: [0, 0], // Last position of the mouse. Used to calculate deltaX and deltaY for our move.\r\n\t\thasMoved: false // If true we will stop click events on the image\r\n\t};\r\n\r\n\tfunction getDragSize(e) {\r\n\t\tvar rc = e.target.getBoundingClientRect(),\r\n\t\t\tp = Math.pow,\r\n\t\t\tdragSize = p(p(e.clientX - rc.left, 2) + p(e.clientY - rc.top, 2), 0.5);\r\n\r\n\t\treturn Math.round(dragSize);\r\n\t}\r\n\r\n\tfunction handleSRStyleToggleVisibility(image) {\r\n\t\tRESUtils.debounce('handleSRStyleToggleVisibility', 50, function() {\r\n\t\t\tvar toggleEle = modules['styleTweaks'].styleToggleContainer;\r\n\t\t\tif (!toggleEle) return;\r\n\t\t\tvar imageElems = image ? [image] : document.querySelectorAll('.RESImage');\r\n\r\n\t\t\tfor (var i = 0; i < imageElems.length; i++) {\r\n\t\t\t\tvar imageEle = imageElems[i];\r\n\t\t\t\tvar imageID = imageEle.getAttribute('id');\r\n\r\n\t\t\t\tif (RESUtils.doElementsCollide(toggleEle, imageEle, 15)) {\r\n\t\t\t\t\tmodules['styleTweaks'].setSRStyleToggleVisibility(false, 'imageZoom-' + imageID);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmodules['styleTweaks'].setSRStyleToggleVisibility(true, 'imageZoom-' + imageID);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction setPlaceholder(mediaTag) {\r\n\t\tif (!$(mediaTag).data('imagePlaceholder')) {\r\n\t\t\tvar thisPH = document.createElement('div');\r\n\t\t\t$(thisPH).addClass('RESImagePlaceholder');\r\n\t\t\t$(mediaTag).data('imagePlaceholder', thisPH);\r\n\r\n\t\t\tif (mediaTag.tagName === 'VIDEO') {\r\n\t\t\t\t// the placeholder for videos should be sibling to .res-player\r\n\t\t\t\t$(mediaTag).closest('.res-player').parent().append(thisPH);\r\n\t\t\t} else {\r\n\t\t\t\t$(mediaTag).parent().append(thisPH);\r\n\t\t\t}\r\n\t\t}\r\n\t\t// we need to use a different onload event for videos...\r\n\t\tif (mediaTag.tagName === 'VIDEO') {\r\n\t\t\tmediaTag.addEventListener('loadeddata', handleMediaLoad);\r\n\t\t} else {\r\n\t\t\tmediaTag.addEventListener('load', handleMediaLoad);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction handleMediaLoad() {\r\n\t\t// don't do this twice (e.g. on image reload from cache), as we get bad height/width data.\r\n\t\tif ($(this).data('loaded')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tsyncPlaceholder(this);\r\n\r\n\t\tif (!this.tagName) { //validation to fix issue #1672\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t$(this).data('loaded', true);\r\n\t\tif (this.tagName !== 'VIDEO') {\r\n\t\t\tthis.style.position = 'absolute';\r\n\t\t} else {\r\n\t\t\tvar $resPlayer = $(this.parentNode).closest('.res-player');\r\n\t\t\t$resPlayer[0].style.position = 'absolute';\r\n\t\t}\r\n\t}\r\n\r\n\tfunction syncPlaceholder(e) {\r\n\t\tvar ele = e.target || e;\r\n\t\tvar thisPH = $(ele).data('imagePlaceholder');\r\n\t\tif (ele.tagName !== 'VIDEO') {\r\n\t\t\t$(thisPH).width($(ele).width() + 'px').height($(ele).height() + 'px');\r\n\t\t} else {\r\n\t\t\t// get the div.res-player and sync it too\r\n\t\t\tvar $resPlayer = $(ele.parentNode).closest('.res-player');\r\n\t\t\t$resPlayer.width($(ele).width() + 'px');\r\n\t\t\t$(thisPH).height($resPlayer.height() + 'px');\r\n\t\t}\r\n\t\tupdateParentHeight(ele);\r\n\t}\r\n\r\n\tfunction setMediaClippyText(elem) {\r\n\t\tif (!module.options.clippy.value && elem.title) return;\r\n\r\n\t\tvar clippy = [], title;\r\n\t\tif (module.options.imageZoom.value) {\r\n\t\t\tclippy.push('drag to resize');\r\n\t\t}\r\n\r\n\t\tif (elem.tagName === 'IMG' && module.options.imageMove.value) {\r\n\t\t\tclippy.push('shift-drag to move');\r\n\t\t}\r\n\r\n\t\ttitle = clippy.join(' or ');\r\n\r\n\t\telem.setAttribute('title', title);\r\n\t}\r\n\r\n\tmodule.makeMediaZoomable = function(mediaTag) {\r\n\t\tif (module.options.imageZoom.value) {\r\n\t\t\tsetPlaceholder(mediaTag);\r\n\t\t\tsetMediaClippyText(mediaTag);\r\n\r\n\t\t\tmediaTag.addEventListener('mousedown', mousedownMedia, false);\r\n\t\t\tmediaTag.addEventListener('mouseup', dragMedia, false);\r\n\t\t\tmediaTag.addEventListener('mousemove', dragMedia, false);\r\n\t\t\tmediaTag.addEventListener('mouseout', mouseoutMedia, false);\r\n\r\n\t\t\t// click event is unneeded for HTML5 video -- but allow Gfycat, giphy and gifyoutube to follow gif behaviour\r\n\t\t\tif (mediaTag.tagName !== 'VIDEO' || mediaTag.className.indexOf('gfyRVid') !== -1 || mediaTag.className.indexOf('giphyVid') !== -1 || mediaTag.className.indexOf('gifyoutubeVid') !== -1 || mediaTag.className.indexOf('imgurgifvVid') !== -1) {\r\n\t\t\t\tmediaTag.addEventListener('click', clickMedia, false);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tmodule.makeMediaMovable = function(mediaTag) {\r\n\t\tif (module.options.imageMove.value) {\r\n\t\t\tsetMediaClippyText(mediaTag);\r\n\t\t\t// We can add duplicates safely without checking if makeMediaZoomable already added them\r\n\t\t\t// because duplicate EventListeners are discarded\r\n\t\t\t// See: https://developer.mozilla.org/en-US/docs/Web/API/EventTarget.addEventListener\r\n\t\t\tmediaTag.addEventListener('mousedown', mousedownMedia, false);\r\n\t\t\t// The click event fires after the mouseup event, and it is the click event that triggers link following.\r\n\t\t\t// Therefore preventing this event and not mouseup.\r\n\t\t\t// If we haven't moved we should not prevent the default behaviour\r\n\t\t\tmediaTag.addEventListener('click', function(e) {\r\n\t\t\t\tif (moveTargetData.moving && moveTargetData.hasMoved) {\r\n\t\t\t\t\tmoveTargetData.moving = false;\r\n\t\t\t\t\te.preventDefault();\r\n\t\t\t\t}\r\n\t\t\t}, false);\r\n\t\t\tmediaTag.addEventListener('mousemove', checkMoveMedia, false);\r\n\t\t\tmediaTag.addEventListener('mouseout', function(e) {\r\n\t\t\t\tmoveTargetData.moving = false;\r\n\t\t\t}, false);\r\n\t\t\t// Set this so the image is displayed above the \"Set tag\" buttons\r\n\t\t\tmediaTag.style.zIndex = 1;\r\n\t\t}\r\n\t};\r\n\r\n\tfunction mousedownMedia(e) {\r\n\t\tif (e.button === 0) {\r\n\t\t\tif (!e.shiftKey) {\r\n\t\t\t\tif (e.target.tagName === 'VIDEO' && e.target.hasAttribute('controls')) {\r\n\t\t\t\t\tvar rc = e.target.getBoundingClientRect();\r\n\t\t\t\t\t// ignore drag if click is in control area (40 px from bottom of video)\r\n\t\t\t\t\tif ((rc.height - 40) < (e.clientY - rc.top)) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif (!e.target.minWidth) e.target.minWidth = Math.max(1, Math.min($(e.target).width(), 100));\r\n\t\t\t\tdragTargetData.imageWidth = $(e.target).width();\r\n\t\t\t\tdragTargetData.diagonal = getDragSize(e);\r\n\t\t\t\tdragTargetData.dragging = false;\r\n\t\t\t\tdragTargetData.hasChangedWidth = false;\r\n\t\t\t} else {\r\n\t\t\t\t// Record where the move began, both for the cursor and the image\r\n\t\t\t\tmoveTargetData.moving = true;\r\n\t\t\t\tmoveTargetData.hasMoved = false;\r\n\t\t\t\tmoveTargetData.mouseLastPos = [e.clientX, e.clientY];\r\n\t\t\t}\r\n\t\t\te.preventDefault();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction mouseoutMedia(e) {\r\n\t\tdragTargetData.diagonal = 0;\r\n\t}\r\n\r\n\tfunction dragMedia(e) {\r\n\t\tif (dragTargetData.diagonal) {\r\n\t\t\tvar newDiagonal = getDragSize(e),\r\n\t\t\t\toldDiagonal = dragTargetData.diagonal,\r\n\t\t\t\timageWidth = dragTargetData.imageWidth,\r\n\t\t\t\tmaxWidth = Math.max(e.target.minWidth, newDiagonal / oldDiagonal * imageWidth);\r\n\r\n\t\t\tif (Math.abs(newDiagonal - oldDiagonal) > 5 && e.target.tagName == 'VIDEO') {\r\n\t\t\t\te.target.preventPlayPause = true;\r\n\t\t\t}\r\n\r\n\t\t\tmodule.resizeMedia(e.target, maxWidth);\r\n\t\t\tdragTargetData.dragging = true;\r\n\t\t}\r\n\t\thandleSRStyleToggleVisibility(e.target);\r\n\t\tif (e.type === 'mouseup') {\r\n\t\t\tdragTargetData.diagonal = 0;\r\n\t\t}\r\n\t}\r\n\r\n\tfunction checkMoveMedia(e) {\r\n\t\tif (moveTargetData.moving) {\r\n\t\t\tvar deltaX = e.clientX - moveTargetData.mouseLastPos[0],\r\n\t\t\t\tdeltaY = e.clientY - moveTargetData.mouseLastPos[1];\r\n\t\t\tmodule.moveMedia(e.target, deltaX, deltaY);\r\n\r\n\t\t\tmoveTargetData.mouseLastPos[0] = e.clientX;\r\n\t\t\tmoveTargetData.mouseLastPos[1] = e.clientY;\r\n\t\t\tmoveTargetData.hasMoved = true;\r\n\t\t}\r\n\t}\r\n\r\n\tmodule.moveMedia = function(ele, deltaX, deltaY) {\r\n\t\t$(ele).css('margin-left', parseInt($(ele).css('margin-left'), 10) + deltaX);\r\n\t\t$(ele).css('margin-top', parseInt($(ele).css('margin-top'), 10) + deltaY);\r\n\r\n\t\tif (ele.tagName !== 'VIDEO') {\r\n\t\t\tele.style.position = 'absolute';\r\n\t\t} else {\r\n\t\t\t// get the div.res-player and sync it too\r\n\t\t\tvar $resPlayer = $(ele.parentNode).closest('.res-player');\r\n\t\t\t$resPlayer[0].style.position = 'absolute';\r\n\t\t}\r\n\r\n\t\tsyncPlaceholder(ele);\r\n\t};\r\n\r\n\tfunction clickMedia(e) {\r\n\t\tdragTargetData.diagonal = 0;\r\n\t\tif (dragTargetData.hasChangedWidth) {\r\n\t\t\tdragTargetData.dragging = false;\r\n\t\t\t// if video let video controls function\r\n\t\t\tif (e.target.tagName === 'VIDEO' && e.target.hasAttribute('controls')) {\r\n\t\t\t\tvar rc = e.target.getBoundingClientRect();\r\n\t\t\t\t// ignore drag if click is in control area (40 px from bottom of video)\r\n\t\t\t\tif ((rc.height - 40) < (e.clientY - rc.top)) {\r\n\t\t\t\t\treturn true;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\te.preventDefault();\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tdragTargetData.hasChangedWidth = false;\r\n\t}\r\n\r\n\tmodule.resizeMedia = function(ele, newWidth) {\r\n\t\tvar currWidth = $(ele).width();\r\n\t\tif (newWidth !== currWidth) {\r\n\t\t\tdragTargetData.hasChangedWidth = true;\r\n\r\n\t\t\tele.style.width = newWidth + 'px';\r\n\t\t\tele.style.maxWidth = newWidth + 'px';\r\n\t\t\tele.style.maxHeight = '';\r\n\t\t\tele.style.height = 'auto';\r\n\r\n\t\t\tif (ele.tagName !== 'VIDEO') {\r\n\t\t\t\tele.style.position = 'absolute';\r\n\t\t\t} else {\r\n\t\t\t\t// get the div.res-player and sync it too\r\n\t\t\t\tvar $resPlayer = $(ele.parentNode).closest('.res-player');\r\n\t\t\t\t$resPlayer[0].style.position = 'absolute';\r\n\t\t\t}\r\n\r\n\t\t\tsyncPlaceholder(ele);\r\n\t\t}\r\n\t};\r\n\r\n\tfunction updateParentHeight(ele) {\r\n\t\tif (module.options.autoMaxHeight.value && ele) {\r\n\t\t\tvar parent = $(ele).closest('.md')[0],\r\n\t\t\t\ttype = $(parent).closest('body:not(.comments-page) .expando')[0] || $(parent).closest('.thing')[0];\r\n\t\t\tif (parent && (type.classList.contains('expando') || type.classList.contains('comment'))) {\r\n\t\t\t\tvar placeholders = $(parent).find('.expando-button.expanded + * .RESImagePlaceholder, .expando-button.expanded + * > *:not(p)'),\r\n\t\t\t\t\theight = 0,\r\n\t\t\t\t\ttempHeight,\r\n\t\t\t\t\tselfMax = parseInt(module.options.selfTextMaxHeight.value, 10),\r\n\t\t\t\t\tcommentMax = parseInt(module.options.commentMaxHeight.value, 10);\r\n\r\n\t\t\t\tfor (var i = 0; i < placeholders.length; i++) {\r\n\t\t\t\t\ttempHeight = $(placeholders[i]).height();\r\n\t\t\t\t\tif ((tempHeight || 0) > height) {\r\n\t\t\t\t\t\theight = tempHeight;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (selfMax && type.classList.contains('expando')) {\r\n\t\t\t\t\tparent.style.maxHeight = ((height > selfMax) ? height : selfMax) + 'px';\r\n\t\t\t\t} else if (commentMax && type.classList.contains('comment')) {\r\n\t\t\t\t\tparent.style.maxHeight = ((height > commentMax) ? height : commentMax) + 'px';\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tmodule.siteModules = {\r\n\t\t'default': {\r\n\t\t\tdomains: [],\r\n\t\t\tacceptRegex: /^[^#]+?\\.(gif|jpe?g|png)(?:[?&#_].*|$)/i,\r\n\t\t\trejectRegex: /(?:wikipedia\\.org\\/wiki|(?:i\\.|m\\.)?imgur\\.com|photobucket\\.com|gifsound\\.com|gfycat\\.com|\\/wiki\\/File:.*|reddit\\.com|onedrive\\.live\\.com|500px\\.(?:com|net|org)|(?:www\\.|share\\.)?gifyoutube\\.com)|futurism\\.co/i,\r\n\t\t\tdetect: function(href, elem) {\r\n\t\t\t\tvar siteMod = module.siteModules['default'];\r\n\t\t\t\treturn (siteMod.acceptRegex.test(href) && !siteMod.rejectRegex.test(href));\r\n\t\t\t},\r\n\t\t\thandleLink: function(elem) {\r\n\t\t\t\tvar def = $.Deferred();\r\n\r\n\t\t\t\tdef.resolve(elem, {\r\n\t\t\t\t\ttype: 'IMAGE',\r\n\t\t\t\t\tsrc: elem.href\r\n\t\t\t\t});\r\n\t\t\t\treturn def.promise();\r\n\t\t\t},\r\n\t\t\thandleInfo: function(elem, info) {\r\n\t\t\t\tvar def = $.Deferred();\r\n\r\n\t\t\t\telem.type = info.type;\r\n\t\t\t\telem.src = info.src;\r\n\r\n\t\t\t\tif (RESUtils.pageType() === 'linklist' && elem.classList.contains('title')) {\r\n\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tdef.resolve(elem);\r\n\t\t\t\treturn def.promise();\r\n\t\t\t}\r\n\t\t},\r\n\t\t'defaultVideo': {\r\n\t\t\tdomains: [],\r\n\t\t\tacceptRegex: /^[^#]+?\\.(webm|mp4|ogv|3gp)(?:[?&#_].*|$)/i,\r\n\t\t\trejectRegex: /(?:onedrive\\.live\\.com)/i,\r\n\t\t\tvideoDetect: document.createElement('VIDEO'),\r\n\t\t\tdetect: function(href, elem) {\r\n\t\t\t\tvar siteMod = module.siteModules['defaultVideo'];\r\n\t\t\t\treturn (siteMod.acceptRegex.test(href) && !siteMod.rejectRegex.test(href));\r\n\t\t\t},\r\n\t\t\thandleLink: function(elem) {\r\n\t\t\t\tvar def = $.Deferred();\r\n\t\t\t\tvar siteMod = module.siteModules['defaultVideo'];\r\n\t\t\t\tvar groups = siteMod.acceptRegex.exec(elem.href);\r\n\r\n\t\t\t\tif (groups) {\r\n\t\t\t\t\t// Change ogv to ogg format.\r\n\t\t\t\t\tif (groups[1] === 'ogv') groups[1] = 'ogg';\r\n\r\n\t\t\t\t\tvar format = 'video/' + groups[1];\r\n\r\n\t\t\t\t\t// Only add the inline video player if the users browser\r\n\t\t\t\t\t// 'probably' or 'maybe' supports the linked video format.\r\n\t\t\t\t\t// This should cover most video problems. You can never be\r\n\t\t\t\t\t// sure if the client supports the codecs used in the container.\r\n\t\t\t\t\tif (siteMod.videoDetect.canPlayType(format) !== '') {\r\n\t\t\t\t\t\tdef.resolve(elem, {\r\n\t\t\t\t\t\t\ttype: 'VIDEO',\r\n\t\t\t\t\t\t\tsrc: elem.href,\r\n\t\t\t\t\t\t\tformat: format\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdef.reject();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdef.reject();\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn def.promise();\r\n\t\t\t},\r\n\t\t\thandleInfo: function(elem, info) {\r\n\t\t\t\telem.expandoOptions = {\r\n\t\t\t\t\tautoplay: false,\r\n\t\t\t\t\tloop: false\r\n\t\t\t\t};\r\n\t\t\t\tvar sources = [{\r\n\t\t\t\t\t'file': info['src'],\r\n\t\t\t\t\t'type': info['format']\r\n\t\t\t\t}];\r\n\r\n\t\t\t\telem.type = 'VIDEO';\r\n\t\t\t\t$(elem).data('sources', sources);\r\n\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t}\r\n\t\t\t\treturn $.Deferred().resolve(elem).promise();\r\n\t\t\t}\r\n\t\t},\r\n\t\t'defaultAudio': {\r\n\t\t\tdomains: [],\r\n\t\t\tacceptRegex: /^[^#]+?\\.(opus|weba|ogg|wav|mp3|flac)(?:[?&#_].*|$)/i,\r\n\t\t\trejectRegex: /(?:onedrive\\.live\\.com)/i,\r\n\t\t\taudioDetect: document.createElement('AUDIO'),\r\n\t\t\tdetect: function(href, elem) {\r\n\t\t\t\tvar siteMod = module.siteModules['defaultAudio'];\r\n\t\t\t\treturn (siteMod.acceptRegex.test(href) && !siteMod.rejectRegex.test(href));\r\n\t\t\t},\r\n\t\t\thandleLink: function(elem) {\r\n\t\t\t\tvar def = $.Deferred();\r\n\t\t\t\tvar siteMod = module.siteModules['defaultAudio'];\r\n\t\t\t\tvar groups = siteMod.acceptRegex.exec(elem.href);\r\n\r\n\t\t\t\tif (groups) {\r\n\t\t\t\t\t// Change weba and opus to their correct containers.\r\n\t\t\t\t\tif (groups[1] === 'weba') groups[1] = 'webm';\r\n\t\t\t\t\tif (groups[1] === 'opus') groups[1] = 'ogg';\r\n\r\n\t\t\t\t\tvar format = 'audio/' + groups[1];\r\n\r\n\t\t\t\t\t// Only add the inline audio player if the users browser\r\n\t\t\t\t\t// 'probably' or 'maybe' supports the linked audio format.\r\n\t\t\t\t\t// This should cover most aduio problems. You can never be\r\n\t\t\t\t\t// sure if the client supports the codecs used in the container.\r\n\t\t\t\t\tif (siteMod.audioDetect.canPlayType(format) !== '') {\r\n\t\t\t\t\t\tdef.resolve(elem, {\r\n\t\t\t\t\t\t\ttype: 'AUDIO',\r\n\t\t\t\t\t\t\tsrc: elem.href,\r\n\t\t\t\t\t\t\tformat: format\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdef.reject();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tdef.reject();\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn def.promise();\r\n\t\t\t},\r\n\t\t\thandleInfo: function(elem, info) {\r\n\t\t\t\telem.expandoOptions = {\r\n\t\t\t\t\tautoplay: true,\r\n\t\t\t\t\tloop: false\r\n\t\t\t\t};\r\n\t\t\t\tvar sources = [{\r\n\t\t\t\t\t'file': info['src'],\r\n\t\t\t\t\t'type': info['format']\r\n\t\t\t\t}];\r\n\r\n\t\t\t\telem.type = 'AUDIO';\r\n\t\t\t\t$(elem).data('sources', sources);\r\n\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t}\r\n\t\t\t\treturn $.Deferred().resolve(elem).promise();\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n});\r\n"],"sourceRoot":"/source/"}