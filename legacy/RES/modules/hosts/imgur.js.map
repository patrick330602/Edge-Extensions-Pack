{"version":3,"sources":["modules/hosts/imgur.js"],"names":[],"mappings":"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","file":"modules/hosts/imgur.js","sourcesContent":["addLibrary('mediaHosts', 'imgur', {\r\n\tdomains: ['imgur.com'],\r\n\toptions: {\r\n\t\t'prefer RES albums': {\r\n\t\t\tdescription: 'Prefer RES support for imgur albums rather than reddit\\'s built in support',\r\n\t\t\tvalue: true,\r\n\t\t\ttype: 'boolean'\r\n\t\t}\r\n\t},\r\n\tcdnURL: location.protocol + '//i.imgur.com/',\r\n\tapiPrefix: 'https://api.imgur.com/3/',\r\n\tapiID: '1d8d9b36339e0e2',\r\n\r\n\t// hashRe: /^https?:\\/\\/(?:i\\.|edge\\.|www\\.)*imgur\\.com\\/(?:r\\/[\\w]+\\/)?([\\w]{5,}(?:[&,][\\w]{5,})?)(\\..+)?(?:#(\\d*))?$/i,\r\n\t// the modified regex below fixes detection of \"edited\" imgur images, but imgur's edited images are broken right now actually, falling into\r\n\t// a redirect loop.  preserving the old one just in case.  however it also fixes detection of the extension (.jpg, for example) which\r\n\t// was too greedy a search...\r\n\t// the hashRe below was provided directly by MrGrim (well, everything after the domain was), using that now.\r\n\t// in addition to the above, the album index was moved out of the first capture group.\r\n\thashRe: /^https?:\\/\\/(?:i\\.|m\\.|edge\\.|www\\.)*imgur\\.com\\/(?:r\\/[\\w]+\\/)*(?!gallery)(?!removalrequest)(?!random)(?!memegen)([\\w]{5,7}(?:[&,][\\w]{5,7})*)(?:#\\d+)?[sbtmlh]?(\\.(?:jpe?g|gif|png|gifv))?(\\?.*)?$/i,\r\n\thostedHashRe: /^https?:(\\/\\/i\\.\\w+\\.*imgur\\.com\\/)([\\w]{5,7}(?:[&,][\\w]{5,7})*)(?:#\\d+)?[sbtmlh]?(\\.(?:jpe?g|gif|png))?(\\?.*)?$/i,\r\n\tgalleryHashRe: /^https?:\\/\\/(?:m\\.)?imgur\\.com\\/gallery\\/([\\w]+)(\\..+)?(?:\\/)?(?:#?\\w*)?$/i,\r\n\talbumHashRe: /^https?:\\/\\/(?:m\\.)?imgur\\.com\\/a\\/([\\w]+)(\\..+)?(?:\\/)?(?:#?\\w*)?$/i,\r\n\tdetect: function(href, elem) {\r\n\t\treturn href.indexOf('imgur.com/') !== -1;\r\n\t},\r\n\t_api: function(endpoint) {\r\n\t\tvar def = $.Deferred();\r\n\r\n\t\tRESEnvironment.ajax({\r\n\t\t\tmethod: 'GET',\r\n\t\t\turl: this.apiPrefix + endpoint,\r\n\t\t\theaders: {\r\n\t\t\t\t'Authorization': 'Client-ID ' + this.apiID\r\n\t\t\t},\r\n\t\t\t// aggressiveCache: true,\r\n\t\t\tonload: function(response) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar json = JSON.parse(response.responseText);\r\n\t\t\t\t\tif (json.data.error || response.status === 404) {\r\n\t\t\t\t\t\tdef.reject(response, json.data.error);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdef.resolve(json.data);\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tdef.reject(error);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonerror: function(response) {\r\n\t\t\t\tdef.reject(response);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\thandleLink: function(elem) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tdef,\r\n\t\t\thref = elem.href.split('?')[0],\r\n\t\t\tgroups, hash;\r\n\r\n\t\tif ((groups = siteMod.galleryHashRe.exec(href))) {\r\n\t\t\thash = groups[1];\r\n\t\t\tdef = siteMod._api('gallery/' + encodeURIComponent(hash));\r\n\t\t} else if ((groups = siteMod.albumHashRe.exec(href))) {\r\n\t\t\tif (modules['showImages'].options['prefer RES albums'].value === true) {\r\n\t\t\t\thash = groups[1];\r\n\t\t\t\telem.imgHash = hash;\r\n\t\t\t\tdef = siteMod._api('album/' + encodeURIComponent(hash));\r\n\t\t\t}\r\n\t\t} else if ((groups = siteMod.hostedHashRe.exec(href))) {\r\n\t\t\thash = groups[2];\r\n\t\t\tdef = siteMod._handleImage(hash, href);\r\n\t\t} else if ((groups = siteMod.hashRe.exec(href))) {\r\n\t\t\thash = groups[1];\r\n\t\t\tif (hash.search(/[&,]/) > -1) {\r\n\t\t\t\t// handle separated list of IDs\r\n\t\t\t\tdef = siteMod._handleImageCollection(hash.split(/[&,]/), href);\r\n\t\t\t} else {\r\n\t\t\t\tdef = siteMod._handleImage(hash, href);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (def) {\r\n\t\t\tdef = def.then(function(info) {\r\n\t\t\t\treturn $.Deferred().resolve(elem, info).promise();\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tdef = $.Deferred().reject();\r\n\t\t}\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\t_deferredImages: {},\r\n\t_deferredImageQueue: [],\r\n\t_handleImage: function(hash, url) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tdef;\r\n\r\n\t\tif (!siteMod._deferredImages[hash]) {\r\n\t\t\tdef = $.Deferred();\r\n\t\t\tsiteMod._deferredImages[hash] = def;\r\n\t\t\tsiteMod._deferredImageQueue.push({\r\n\t\t\t\turl: url,\r\n\t\t\t\thash: hash,\r\n\t\t\t\tdeferred: def\r\n\t\t\t});\r\n\t\t\tRESUtils.debounce('showImages.imgur.batchHandleImages', 500, siteMod._batchHandleImages.bind(siteMod));\r\n\t\t}\r\n\r\n\t\treturn siteMod._deferredImages[hash].promise();\r\n\t},\r\n\t_batchHandleImages: function() {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tqueue = siteMod._deferredImageQueue;\r\n\t\tsiteMod._deferredImageQueue = [];\r\n\r\n\t\tqueue.forEach(function(item) {\r\n\t\t\tvar def,\r\n\t\t\t\textension = (extension = siteMod.hashRe.exec(item.url)) && extension[2];\r\n\r\n\t\t\tif (['.gif', '.gifv', '.png'].indexOf(extension)) {\r\n\t\t\t\t// Extension is given and hopefully correct, so we can intuit the mimetype\r\n\t\t\t\t// removed caption API calls as they don't seem to exist/matter for single images, only albums...\r\n\t\t\t\t// If we don't show captions and know the mimetype, then we can skip the API call.\r\n\t\t\t\tdef = siteMod._hashMockAPI(item.hash, item.url);\r\n\t\t\t} else if (siteMod.hostedHashRe.test(item.url)) {\r\n\t\t\t\tdef = siteMod._hashMockAPI(item.hash, item.url);\r\n\t\t\t} else {\r\n\t\t\t\t// Check if image is gifv\r\n\t\t\t\tdef = siteMod._api('image/' + item.hash);\r\n\t\t\t}\r\n\r\n\t\t\tdef\r\n\t\t\t\t.done(item.deferred.resolve)\r\n\t\t\t\t.fail(item.deferred.reject);\r\n\t\t});\r\n\t},\r\n\r\n\t_hashMockAPI: function(hash, url) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tdef = $.Deferred(), matches,\r\n\t\t\textension, mimeType, cdnURL;\r\n\r\n\t\tcdnURL = siteMod.cdnURL;\r\n\r\n\t\tif ((matches = siteMod.hostedHashRe.exec(url))) {\r\n\t\t\tcdnURL = matches[1];\r\n\t\t\textension = matches[3];\r\n\t\t} else if ((matches = siteMod.hashRe.exec(url))) {\r\n\t\t\textension = matches[2];\r\n\t\t}\r\n\r\n\t\tif (!extension) {\r\n\t\t\t// Imgur doesn't really care about the extension except video and the browsers don't seem to either.\r\n\t\t\textension = '.jpg';\r\n\t\t}\r\n\r\n\t\tmimeType = (extension === '.jpg') ? 'image/jpeg' : 'image/' + extension.substr(1);\r\n\r\n\t\tif (extension === '.gifv' || extension === '.gif') {\r\n\t\t\tdef.resolve({\r\n\t\t\t\tid: hash,\r\n\t\t\t\tlooping: true,\r\n\t\t\t\tanimated: true,\r\n\t\t\t\text: extension,\r\n\t\t\t\ttype: 'image/gif',\r\n\t\t\t\tgifv: cdnURL + hash + '.gifv',\r\n\t\t\t\twebm: cdnURL + hash + '.webm',\r\n\t\t\t\tmp4: cdnURL + hash + '.mp4',\r\n\t\t\t\tlink: cdnURL + hash + '.gif',\r\n\t\t\t\tdownload: cdnURL + 'download/' + hash\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tdef.resolve({\r\n\t\t\t\tid: hash,\r\n\t\t\t\tanimated: false,\r\n\t\t\t\tlooping: false,\r\n\t\t\t\text: extension,\r\n\t\t\t\tlink: cdnURL + hash + extension,\r\n\t\t\t\ttype: mimeType\r\n\t\t\t});\r\n\t\t}\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\t_handleImageCollection: function(hashes, url) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tdef,\r\n\t\t\texpandoInfo = {\r\n\t\t\t\tis_album: true\r\n\t\t\t};\r\n\r\n\t\tdef = RESUtils.deferred.map(hashes, function(hash) {\r\n\t\t\treturn siteMod._hashMockAPI(hash, url);\r\n\t\t}).then(function(images) {\r\n\t\t\texpandoInfo.images = images;\r\n\t\t\treturn expandoInfo;\r\n\t\t});\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\thandleInfo: function(elem, info) {\r\n\t\t// Provide\r\n\t\tvar def;\r\n\t\tif (info.images && info.images.length) {\r\n\t\t\tdef = modules['showImages'].siteModules['imgur']._handleAlbum(elem, info);\r\n\t\t} else if (info.gifv) {\r\n\t\t\tdef = modules['showImages'].siteModules['imgur']._handleGifv(elem, info);\r\n\t\t} else if (info.link) {\r\n\t\t\tdef = modules['showImages'].siteModules['imgur']._handleSingleImage(elem, info);\r\n\t\t}\r\n\r\n\t\tif (def) {\r\n\t\t\tdef = def.then(function(expandoInfo) {\r\n\t\t\t\t$.extend(true, elem, expandoInfo);\r\n\t\t\t\treturn elem;\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tdef = $.Deferred().reject();\r\n\t\t\t// console.log('ERROR', info);\r\n\t\t\t// console.log(arguments.callee.caller);\r\n\t\t}\r\n\r\n\t\treturn def.promise();\r\n\t},\r\n\t_handleSingleImage: function(elem, info) {\r\n\t\tvar link = info.link;\r\n\r\n\t\tif (location.protocol === 'https:') {\r\n\t\t\tlink = link.replace('http:', 'https:');\r\n\t\t}\r\n\t\tvar expandoInfo = {\r\n\t\t\tsrc: link,\r\n\t\t\ttype: 'IMAGE',\r\n\t\t\tcaption: info.caption,\r\n\t\t\ttitle: info.title\r\n\t\t};\r\n\t\treturn $.Deferred().resolve(expandoInfo).promise();\r\n\t},\r\n\t_handleAlbum: function(elem, info) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\tdeferred,\r\n\t\t\texpandoInfo = {},\r\n\t\t\tbase = elem.href.split('#')[0];\r\n\r\n\t\tdeferred = RESUtils.deferred.map(info.images, function(info, i, a) {\r\n\t\t\tvar deferred,\r\n\t\t\t\texpandoInfo;\r\n\r\n\t\t\texpandoInfo = {\r\n\t\t\t\ttitle: info.title,\r\n\t\t\t\tcaption: info.description,\r\n\t\t\t\thref: base + '#' + info.id\r\n\t\t\t};\r\n\t\t\t//if (info.gifv) {\r\n\t\t\t//\tdeferred = siteMod._handleGifv(elem, info);\r\n\t\t\t//} else {\r\n\t\t\tdeferred = siteMod._handleSingleImage(elem, info);\r\n\t\t\t//}\r\n\r\n\t\t\tdeferred = deferred.then(function(imageExpandoInfo) {\r\n\t\t\t\t$.extend(true, expandoInfo, imageExpandoInfo);\r\n\t\t\t\treturn expandoInfo;\r\n\t\t\t});\r\n\r\n\t\t\treturn deferred.promise();\r\n\t\t})\r\n\t\t.then(function(images) {\r\n\t\t\texpandoInfo.src = images;\r\n\t\t})\r\n\t\t.then(function() {\r\n\t\t\tif (info.hash) {\r\n\t\t\t\tvar hash = info.hash.slice(1);\r\n\t\t\t\tvar galleryStart = parseInt(hash, 10);\r\n\t\t\t\tif (isNaN(galleryStart)) {\r\n\t\t\t\t\tgalleryStart = info.images.findIndex(function(image, i) {\r\n\t\t\t\t\t\treturn hash === info.images[i].image.hash;\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tif (galleryStart === -1) {\r\n\t\t\t\t\t\tgalleryStart = 0;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\texpandoInfo.galleryStart = galleryStart;\r\n\t\t\t}\r\n\t\t\texpandoInfo.imageTitle = info.title;\r\n\t\t\texpandoInfo.caption = info.description;\r\n\t\t\texpandoInfo.type = 'GALLERY';\r\n\t\t})\r\n\t\t.then(function() {\r\n\t\t\treturn expandoInfo;\r\n\t\t});\r\n\t\treturn deferred.promise();\r\n\t},\r\n\t_handleGifv: function(elem, info) {\r\n\t\tvar siteMod = modules['showImages'].siteModules['imgur'],\r\n\t\t\texpandoInfo = {};\r\n\t\texpandoInfo.type = 'GENERIC_EXPANDO';\r\n\t\texpandoInfo.subtype = 'VIDEO';\r\n\t\t// open via 'view all images'\r\n\t\texpandoInfo.expandOnViewAll = true;\r\n\t\texpandoInfo.expandoClass = ' video-muted';\r\n\r\n\t\texpandoInfo.expandoOptions = {\r\n\t\t\tgenerate: siteMod._generateGifv.bind(siteMod, elem, info),\r\n\t\t\tmedia: info\r\n\t\t};\r\n\r\n\t\treturn $.Deferred().resolve(expandoInfo).promise();\r\n\t},\r\n\r\n\t_generateGifv: function(elem, info) {\r\n\t\tvar template = RESTemplates.getSync('imgurgifvUI');\r\n\t\tvar video = {\r\n\t\t\tloop: true,\r\n\t\t\tautoplay: true, // imgurgifv will always be muted, so autoplay is OK\r\n\t\t\tmuted: true,\r\n\t\t\tdirecturl: elem.href,\r\n\t\t\tdownloadurl: info.download\r\n\t\t};\r\n\t\tvideo.sources = [\r\n\t\t\t{\r\n\t\t\t\t'source': info.webm,\r\n\t\t\t\t'type': 'video/webm',\r\n\t\t\t\t'class': 'imgurgifvwebmsrc'\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\t'source': info.mp4,\r\n\t\t\t\t'type': 'video/mp4',\r\n\t\t\t\t'class': 'imgurgifvmp4src'\r\n\t\t\t}\r\n\t\t];\r\n\t\tvar element = template.html(video)[0],\r\n\t\t\tv = element.querySelector('video');\r\n\r\n\t\t// set the max width to the width of the entry area\r\n\t\tv.style.maxWidth = $(elem).closest('.entry').width() + 'px';\r\n\t\tnew window.imgurgifvObject(element, elem.href, info.link);\r\n\t\treturn element;\r\n\t}\r\n});\r\n"],"sourceRoot":"/source/"}