{"version":3,"sources":["modules/hosts/onedrive.js"],"names":[],"mappings":"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","file":"modules/hosts/onedrive.js","sourcesContent":["addLibrary('mediaHosts', 'onedrive', {\r\n\tdomains: ['onedrive.live.com', '1drv.ms'],\r\n\tname: 'Microsoft OneDrive',\r\n\tvideoDetect: document.createElement('VIDEO'),\r\n\taudioDetect: document.createElement('AUDIO'),\r\n\tnoChromePermission: false,\r\n\t// Returns true/false to indicate whether the siteModule will attempt to handle the link.\r\n\t// The only parameters are the actual URL and the anchor element.\r\n\tdetect: function(href, elem) {\r\n\t\treturn href.indexOf('onedrive.live.com/') !== -1 || href.indexOf('1drv.ms/') !== -1;\r\n\t},\r\n\r\n\thandleLink: function(elem) {\r\n\t\tvar def = $.Deferred();\r\n\r\n\t\tvar siteMod = modules['showImages'].siteModules['onedrive'];\r\n\t\tif (elem.href.indexOf('1drv.ms/') !== -1) {\r\n\t\t\tif (siteMod.noChromePermission) {\r\n\t\t\t\tdef.resolve(elem, { isShort: true });\r\n\t\t\t} else {\r\n\t\t\t\tRESEnvironment.ajax({\r\n\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\turl: elem.href,\r\n\t\t\t\t\taggressiveCache: true,\r\n\t\t\t\t\tonload: function(response) {\r\n\t\t\t\t\t\tif (response.responseText === '') {\r\n\t\t\t\t\t\t\tsiteMod.noChromePermission = true;\r\n\t\t\t\t\t\t\tdef.resolve(elem, { isShort: true });\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\tsiteMod.fetchJson(elem, response.responseURL, def);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tsiteMod.fetchJson(elem, elem.href, def);\r\n\t\t}\r\n\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\tfetchJson: function(elem, href, def) {\r\n\t\tvar hashRe = /(?:resid=|&id=)([a-z0-9!%]+)(?:.*&authkey=([a-z0-9%!_-]+)|)/i;\r\n\t\tvar groups = hashRe.exec(href);\r\n\r\n\t\tif (!groups) return def.reject();\r\n\r\n\t\tvar resId = decodeURIComponent(groups[1]);\r\n\t\tvar authKey = decodeURIComponent(groups[2]);\r\n\r\n\t\tvar siteMod = modules['showImages'].siteModules['onedrive'];\r\n\r\n\t\tvar apiURL = 'https://api.onedrive.com/v1.0/drive/items/' + resId + (authKey !== null ? '?authKey=' + authKey : '');\r\n\r\n\t\tRESEnvironment.ajax({\r\n\t\t\tmethod: 'GET',\r\n\t\t\turl: apiURL,\r\n\t\t\taggressiveCache: true,\r\n\t\t\tonload: function(response) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tvar json = JSON.parse(response.responseText);\r\n\t\t\t\t\t// An error happened, reject.\r\n\t\t\t\t\tif (json.error !== undefined) return def.reject();\r\n\r\n\t\t\t\t\t// The link is a folder, get its content instead.\r\n\t\t\t\t\tif (json.folder !== undefined) {\r\n\t\t\t\t\t\tvar folderUrl = 'https://api.onedrive.com/v1.0/drive/items/' + resId + '/children' + (authKey !== null ? '?authKey=' + authKey : '');\r\n\r\n\r\n\t\t\t\t\t\tRESEnvironment.ajax({\r\n\t\t\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\t\t\turl: folderUrl,\r\n\t\t\t\t\t\t\taggressiveCache: true,\r\n\t\t\t\t\t\t\tonload: function(folderResponse) {\r\n\t\t\t\t\t\t\t\tvar folderJson = JSON.parse(folderResponse.responseText);\r\n\t\t\t\t\t\t\t\t// An error happend this time, reject.\r\n\t\t\t\t\t\t\t\tif (json.error !== undefined) return def.reject();\r\n\r\n\t\t\t\t\t\t\t\tjson.files = folderJson.value;\r\n\t\t\t\t\t\t\t\tdef.resolve(elem, json);\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\tonerror: function(folderResponse) {\r\n\t\t\t\t\t\t\t\tdef.reject();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\r\n\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t// Check if the file is a video, if that's the case, check if we can play it.\r\n\t\t\t\t\t\tif (json.video !== undefined) {\r\n\t\t\t\t\t\t\tif (siteMod.videoDetect.canPlayType(json.file.mimeType) === '') {\r\n\t\t\t\t\t\t\t\tdef.reject();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else if (json.audio !== undefined) {\r\n\t\t\t\t\t\t\tif (siteMod.audioDetect.canPlayType(json.file.mimeType) === '') {\r\n\t\t\t\t\t\t\t\tdef.reject();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tdef.resolve(elem, json);\r\n\t\t\t\t\t}\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tdef.reject();\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\tonerror: function(response) {\r\n\r\n\t\t\t\tdef.reject();\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\treturn def.promise();\r\n\t},\r\n\r\n\tresolveElement: function(elem, info) {\r\n\t\tif (info.files === undefined) {\r\n\r\n\t\t\tvar type = info.file.mimeType.substring(0, info.file.mimeType.indexOf('/'));\r\n\r\n\t\t\tswitch (type) {\r\n\t\t\t\tcase 'video':\r\n\t\t\t\t\telem.type = 'VIDEO';\r\n\t\t\t\t\telem.expandoOptions = {\r\n\t\t\t\t\t\tautoplay: false,\r\n\t\t\t\t\t\tloop: false\r\n\t\t\t\t\t};\r\n\t\t\t\t\t$(elem).data('sources', [{\r\n\t\t\t\t\t\t'file': info['@content.downloadUrl'],\r\n\t\t\t\t\t\t'type': info.file.mimeType\r\n\t\t\t\t\t}]);\r\n\r\n\t\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'image':\r\n\t\t\t\t\telem.type = 'IMAGE';\r\n\t\t\t\t\telem.src = info['@content.downloadUrl'];\r\n\r\n\t\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tcase 'audio':\r\n\t\t\t\t\telem.type = 'AUDIO';\r\n\t\t\t\t\telem.expandoOptions = {\r\n\t\t\t\t\t\tautoplay: true,\r\n\t\t\t\t\t\tloop: false\r\n\t\t\t\t\t};\r\n\t\t\t\t\t$(elem).data('sources', [{\r\n\t\t\t\t\t\t'file': info['@content.downloadUrl'],\r\n\t\t\t\t\t\t'type': info.file.mimeType\r\n\t\t\t\t\t}]);\r\n\r\n\t\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbreak;\r\n\t\t\t\tdefault:\r\n\t\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\t// Gallery\r\n\r\n\t\t\tvar gallery = info.files.filter(function(item) {\r\n\t\t\t\treturn item.file.mimeType.indexOf('image') !== -1;\r\n\t\t\t});\r\n\r\n\t\t\tif (gallery === null || gallery.length === 0) return null;\r\n\r\n\t\t\tif (gallery.length > 1) {\r\n\t\t\t\telem.type = 'GALLERY';\r\n\t\t\t\telem.src = gallery.map(function(e, i, a) {\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\tsrc: e['@content.downloadUrl'],\r\n\t\t\t\t\t\thref: e.webUrl\r\n\t\t\t\t\t};\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\telem.type = 'IMAGE';\r\n\t\t\t\telem.src = gallery[0]['@content.downloadUrl'];\r\n\r\n\t\t\t\tif (RESUtils.pageType() === 'linklist') {\r\n\t\t\t\t\t$(elem).closest('.thing').find('.thumbnail').attr('href', elem.href);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn elem;\r\n\t},\r\n\r\n\t// This is where the embedding information is added to the link.\r\n\t// handleInfo sits in the Deferred chain after handleLink\r\n\t// and should receive both the element and a data object from handleLink.\r\n\t// The first parameter should the same anchor element passed to handleLink.\r\n\t// The second parameter should be module-specific data.\r\n\t// A new $.Deferred object should be created and resolved/rejected as necessary and then returned.\r\n\t// If resolving, the element should be passed.\r\n\thandleInfo: function(elem, info) {\r\n\t\tvar def = $.Deferred();\r\n\r\n\t\tvar siteMod = modules['showImages'].siteModules['onedrive'];\r\n\t\tif (info.isShort) {\r\n\t\t\telem.type = 'GENERIC_EXPANDO';\r\n\t\t\telem.expandoClass = ' selftext';\r\n\t\t\telem.doNotExpandInSelfText = BrowserDetect.isChrome();\r\n\t\t\telem.expandoOptions = {\r\n\t\t\t\tgenerate: function() {\r\n\t\t\t\t\tvar genDef = $.Deferred().done(function(genElem, genInfo) {\r\n\t\t\t\t\t\tgenElem = siteMod.resolveElement(genElem, genInfo);\r\n\t\t\t\t\t\tif (genElem === null) {\r\n\t\t\t\t\t\t\tfail();\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\telem = genElem;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tvar target = $(genElem).closest('.entry').find('.expando-button')[0];\r\n\t\t\t\t\t\ttarget.classList.remove('selftext');\r\n\t\t\t\t\t\tswitch (elem.type) {\r\n\t\t\t\t\t\t\tcase 'IMAGE':\r\n\t\t\t\t\t\t\t\ttarget.classList.add('image');\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'GALLERY':\r\n\t\t\t\t\t\t\t\ttarget.classList.add('image gallery');\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tcase 'AUDIO':\r\n\t\t\t\t\t\t\tcase 'VIDEO':\r\n\t\t\t\t\t\t\t\ttarget.classList.add('video');\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\tdefault:\r\n\t\t\t\t\t\t\t\ttarget.classList.add('selftext');\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tmodules['showImages'].revealImage(target, target.classList.contains('collapsedExpando'));\r\n\t\t\t\t\t}).fail(function() {\r\n\t\t\t\t\t\tfail();\r\n\t\t\t\t\t});\r\n\r\n\t\t\t\t\tvar expando = RESUtils.createElement('div', '', 'expando');\r\n\r\n\t\t\t\t\tfunction run() {\r\n\t\t\t\t\t\tRESEnvironment.ajax({\r\n\t\t\t\t\t\t\tmethod: 'GET',\r\n\t\t\t\t\t\t\turl: elem.href,\r\n\t\t\t\t\t\t\taggressiveCache: false,\r\n\t\t\t\t\t\t\tonload: function(response) {\r\n\t\t\t\t\t\t\t\tif (response.responseText === '') {\r\n\t\t\t\t\t\t\t\t\tgenDef.reject();\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\tsiteMod.fetchJson(elem, response.responseURL, genDef);\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t});\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tfunction fail() {\r\n\t\t\t\t\t\t$(expando).html('<span class=\"error\">Error loading OneDrive file.</span>');\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tif (BrowserDetect.isChrome()) {\r\n\t\t\t\t\t\tvar permissionsJSON = {\r\n\t\t\t\t\t\t\trequestType: 'permissions',\r\n\t\t\t\t\t\t\tcallbackID: permissionQueue.count,\r\n\t\t\t\t\t\t\tdata: {\r\n\t\t\t\t\t\t\t\torigins: ['http://1drv.ms/*', 'https://onedrive.live.com/*']\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\t// save a function call that'll run the expando if our permissions request\r\n\t\t\t\t\t\t// comes back with a result of true\r\n\t\t\t\t\t\tpermissionQueue.onloads[permissionQueue.count] = function(hasPermission) {\r\n\t\t\t\t\t\t\tif (hasPermission) {\r\n\t\t\t\t\t\t\t\trun();\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tfail();\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t};\r\n\t\t\t\t\t\tpermissionQueue.count++;\r\n\r\n\t\t\t\t\t\t// we do a noop in the callback here because we can't actually get a\r\n\t\t\t\t\t\t// response - there's multiple async calls going on...\r\n\t\t\t\t\t\tchrome.runtime.sendMessage(permissionsJSON, function(response) { });\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\trun();\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn expando;\r\n\t\t\t\t}\r\n\t\t\t};\r\n\t\t\tdef.resolve(elem);\r\n\t\t} else {\r\n\t\t\telem = siteMod.resolveElement(elem, info);\r\n\t\t\tif (elem === null)\r\n\t\t\t\tdef.reject();\r\n\t\t\telse\r\n\t\t\t\tdef.resolve(elem);\r\n\t\t}\r\n\t\treturn def.promise();\r\n\t}\r\n});\r\n"],"sourceRoot":"/source/"}